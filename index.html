<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Cheese Wonderland â€” Fullscreen Roulette</title>
<style>
  html,body{height:100%;margin:0;background:#04070f;color:#fff;font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,"Noto Sans JP";overflow:hidden}
  #stage{position:fixed;inset:0}

  /* ä¸Šéƒ¨ï¼šæ®‹ã‚Šå›æ•° */
  #leftBadge{position:fixed;left:10px;top:10px;z-index:20;background:rgba(20,24,40,.65);
    border:1px solid rgba(255,255,255,.08);padding:8px 12px;border-radius:10px;font-weight:800}

  /* ä¸‹éƒ¨ï¼šãƒœã‚¿ãƒ³ */
  #controls{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);display:flex;gap:14px;z-index:20}
  button{appearance:none;border:none;border-radius:14px;padding:14px 22px;font-size:18px;font-weight:900;cursor:pointer;
    background:linear-gradient(180deg,#ffe08a,#f7b733);color:#141414;box-shadow:0 10px 28px rgba(0,0,0,.4)}
  button.ghost{background:#1c2342;color:#e9ecff;border:1px solid rgba(255,255,255,.14);box-shadow:none}
  button:disabled{opacity:.5;cursor:not-allowed}
  #mute{width:46px;padding:12px 0}

  /* ä¸Šéƒ¨ä¸­å¤®ãƒã‚¤ãƒ³ã‚¿ */
  #pointer{position:fixed;top:8px;left:50%;transform:translateX(-50%);width:0;height:0;z-index:15;
    border-left:18px solid transparent;border-right:18px solid transparent;border-bottom:28px solid #ff5a76;
    filter:drop-shadow(0 6px 12px rgba(255,90,118,.6))}

  /* ãƒˆãƒ¼ã‚¹ãƒˆï¼ˆå½“ãŸã‚Šè¡¨ç¤ºï¼‰ */
  #toast{position:fixed;left:50%;top:16px;transform:translateX(-50%) translateY(-16px);background:#111533;
    border:1px solid rgba(255,255,255,.18);padding:10px 14px;border-radius:12px;font-weight:800;opacity:0;
    transition:.25s;z-index:30}
  #toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

  /* äººæ•°å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« */
  #start{position:fixed;inset:0;display:grid;place-items:center;background:rgba(5,8,16,.9);z-index:40}
  #start .card{background:linear-gradient(180deg,#161c33,#0f1330);border:1px solid rgba(255,255,255,.1);border-radius:16px;
    padding:20px;width:min(92vw,480px);box-shadow:0 24px 60px rgba(0,0,0,.6)}
  #start .row{display:flex;gap:10px;align-items:center}
  #start input[type=number]{flex:1;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.15);
    background:#0c1126;color:#fff;font-size:18px}

  /* é¡”ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆå½“ãŸã‚Šæ™‚ï¼‰ */
  #faceOverlay{position:fixed;inset:0;display:none;place-items:center;background:radial-gradient(600px 400px at 50% 40%,rgba(255,255,255,.06),transparent 60%);z-index:35;pointer-events:none}
  #faceOverlay img{max-width:60vw;max-height:60vh;border-radius:16px;box-shadow:0 18px 60px rgba(0,0,0,.55);animation:pop .45s ease both}
  @keyframes pop{0%{transform:scale(.86);opacity:0}100%{transform:scale(1);opacity:1}}

  /* æœ€çµ‚ã‚µãƒãƒªãƒ¼ */
  #summary{position:fixed;inset:0;display:none;background:rgba(0,0,0,.92);z-index:50;color:#fff}
  #summary .wrap{max-width:980px;margin:60px auto;padding:0 16px}
  #summary table{width:100%;border-collapse:collapse;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);border-radius:12px;overflow:hidden}
  #summary th,#summary td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08)}
  #summary th{text-align:left;color:#aeb8ff}
  #summary tr:last-child td{border-bottom:none}
</style>
</head>
<body>
<div id="stage"></div>

<div id="pointer"></div>
<div id="leftBadge">æ®‹ã‚Š <b id="leftNum">--</b> å›</div>

<div id="controls">
  <button id="spin">å›ã™ ğŸ¡</button>
  <button id="mute" class="ghost" title="ãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡æ›¿">ğŸ”ˆ</button>
  <button id="reset" class="ghost">ãƒªã‚»ãƒƒãƒˆ ğŸ”„</button>
</div>

<div id="toast">å½“ãŸã‚Šï¼</div>

<!-- äººæ•°å…¥åŠ› -->
<div id="start">
  <div class="card">
    <h2 style="margin:0 0 10px">äººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
    <div class="row">
      <input type="number" id="people" min="1" step="1" value="2">
      <button id="startBtn">é–‹å§‹</button>
    </div>
    <div style="opacity:.7;margin-top:10px">â€» 1äºº2å›ãƒ—ãƒ¬ã‚¤</div>
  </div>
</div>

<!-- é¡”ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="faceOverlay"><img id="faceImg" alt=""></div>

<!-- æœ€çµ‚ã‚µãƒãƒªãƒ¼ -->
<div id="summary">
  <div class="wrap">
    <h2>çµæœã¾ã¨ã‚</h2>
    <div id="list"></div>
    <div style="margin-top:14px;display:flex;gap:10px">
      <button id="again">ã‚‚ã†ä¸€åº¦</button>
      <button id="closeSummary" class="ghost">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<!-- three.jsï¼šémoduleç‰ˆã§ç¢ºå®Ÿå‹•ä½œ -->
<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script>
/* ====== ãƒ‡ãƒ¼ã‚¿ ====== */
const ITEMS = [
  { name:"ãˆã³ãƒ•ãƒªãƒƒã‚¿ãƒ¼", emoji:"ğŸ¤" },
  { name:"ãƒ­ãƒ¼ã‚¹ãƒˆãƒãƒ¼ã‚¯", emoji:"ğŸ–" },
  { name:"ãƒ•ãƒ©ã‚¤ãƒ‰ãƒã‚­ãƒ³", emoji:"ğŸ—" },
  { name:"ãƒã‚²ãƒƒãƒˆ",       emoji:"ğŸ¥–" },
  { name:"é‡èœç››ã‚Š",       emoji:"ğŸ¥¦" },
  { name:"ç‰›ã‚³ãƒ­ã‚«ãƒ„",     emoji:"ğŸ¥©" },
];
const FACES = ["face.png","suprised.png","happy.png","laugh.png","funny.png"];
const N = ITEMS.length, ARC = 360/N;

/* ====== çŠ¶æ…‹ ====== */
let spinsLeft = 0, spinning = false, currentAngle = 0;
let results = []; // {idx, name, emoji}
const leftNum = document.getElementById('leftNum');
const toast = document.getElementById('toast');
const faceOverlay = document.getElementById('faceOverlay');
const faceImg = document.getElementById('faceImg');

/* ====== Three.jsï¼ˆæ­£æŠ•å½±ã§ç”»é¢ãƒ•ã‚£ãƒƒãƒˆï¼‰ ====== */
const stage = document.getElementById('stage');
const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false });
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
renderer.setSize(innerWidth, innerHeight);
stage.appendChild(renderer.domElement);

let camera; // Orthographic
const scene = new THREE.Scene();
const wheelGroup = new THREE.Group(); scene.add(wheelGroup);

// ãƒ©ã‚¤ãƒˆï¼ˆæ§ãˆã‚ï¼‰
scene.add(new THREE.AmbientLight(0xffffff, .8));

const loader = new THREE.TextureLoader();
const tex = loader.load('roulette_ui_6_sections.png');
tex.colorSpace = THREE.SRGBColorSpace;
tex.minFilter = THREE.LinearMipmapLinearFilter;
tex.magFilter = THREE.LinearFilter;
tex.wrapS = tex.wrapT = THREE.ClampToEdgeWrapping;

// 1x1ã®Planeã‚’ä½œã‚Šã€ã‚µã‚¤ã‚ºã¯ãƒªã‚µã‚¤ã‚ºã§ã‚¹ã‚±ãƒ¼ãƒ«
const plane = new THREE.Mesh(
  new THREE.PlaneGeometry(1,1),
  new THREE.MeshBasicMaterial({ map:tex, transparent:true })
);
wheelGroup.add(plane);

// ç”»é¢ã«ãƒ”ãƒƒã‚¿ãƒªã‚¹ã‚±ãƒ¼ãƒ«
function fitToScreen(){
  const w = innerWidth, h = innerHeight;
  renderer.setSize(w, h);
  // æ­£æŠ•å½±ã‚«ãƒ¡ãƒ©ã‚’ãƒ”ã‚¯ã‚»ãƒ«åŸºæº–ã«
  camera = new THREE.OrthographicCamera(-w/2, w/2, h/2, -h/2, -10, 10);
  camera.position.set(0,0,5); camera.lookAt(0,0,0);

  const size = Math.min(w, h) * 0.9; // 90% ã‚’å æœ‰
  plane.scale.set(size, size, 1);
  wheelGroup.position.set(0,0,0);
}
addEventListener('resize', fitToScreen); fitToScreen();

/* ====== æç”»ãƒ«ãƒ¼ãƒ— ====== */
function render(){ renderer.render(scene, camera); requestAnimationFrame(render); }
render();

/* ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
const showToast = (m)=>{ toast.textContent=m; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1100); };
const setLeft = (n)=> leftNum.textContent = n;

/* ====== ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªï¼šã‚¹ãƒ”ãƒ³ä¸­ã ã‘æ°—æŒã¡ã„ã„ãƒ«ãƒ¼ãƒ—ã€å½“ãŸã‚Šã§åŠ¹æœéŸ³ ====== */
let audioCtx, master, loopNode, loopTimer, muted=false;
function ensureAudio(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  master = audioCtx.createGain(); master.gain.value = .4; master.connect(audioCtx.destination);
}
function startSpinLoop(){
  if(muted) return;
  ensureAudio();
  stopSpinLoop();
  // è»½ã„8bité¢¨ãƒ«ãƒ¼ãƒ—ï¼ˆ3éŸ³ã‚’çŸ­ãåˆ»ã‚€ï¼‰
  loopTimer = setInterval(()=>{
    const freqs = [523.25,659.25,783.99]; // C5,E5,G5
    freqs.forEach((f,i)=>{
      const t = audioCtx.currentTime + i*0.08;
      const o = audioCtx.createOscillator(); o.type='triangle'; o.frequency.value=f;
      const g = audioCtx.createGain(); g.gain.value=0.0001;
      o.connect(g).connect(master);
      o.start(t);
      g.gain.setValueAtTime(0.0001,t);
      g.gain.exponentialRampToValueAtTime(0.22,t+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001,t+0.15);
      o.stop(t+0.16);
    });
  }, 260);
}
function stopSpinLoop(){ if(loopTimer){ clearInterval(loopTimer); loopTimer=null; } }
function playHitSFX(){
  if(muted) return;
  ensureAudio();
  const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
  o.type='square'; o.frequency.setValueAtTime(880, audioCtx.currentTime);
  g.gain.value=0.0001; o.connect(g).connect(master); o.start();
  const t = audioCtx.currentTime;
  g.gain.exponentialRampToValueAtTime(0.35, t+0.01);
  o.frequency.exponentialRampToValueAtTime(1760, t+0.1);
  g.gain.exponentialRampToValueAtTime(0.0001, t+0.25);
  o.stop(t+0.26);
}

/* ====== ã‚¹ãƒ”ãƒ³ ====== */
function pick(){ return Math.floor(Math.random()*N); }

function spin(){
  if(spinning || spinsLeft<=0) return;
  spinning = true; document.getElementById('spin').disabled = true;
  startSpinLoop();

  const idx = pick();
  // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ä¸­å¿ƒè§’åº¦ï¼ˆå³=0Â°æƒ³å®šï¼‰â†’ ãƒã‚¤ãƒ³ã‚¿ã¯ä¸Š(90Â°) ãªã®ã§ center-90
  const center = idx*ARC + ARC/2;
  const jitter = (Math.random()*ARC*0.2) - (ARC*0.1);
  const deltaDeg = -(6*360 + (center - 90) + jitter); // 6å›è»¢+ç›®æ¨™
  const start = currentAngle;
  const end = start + THREE.MathUtils.degToRad(deltaDeg);
  const dur = 5200; const t0 = performance.now();

  function easeOutCubic(t){ return 1 - Math.pow(1-t, 3); }
  function anim(now){
    const t = Math.min(1, (now-t0)/dur);
    const k = easeOutCubic(t);
    wheelGroup.rotation.z = start + (end-start)*k;
    if(t<1) requestAnimationFrame(anim);
    else{
      currentAngle = end;
      stopSpinLoop();
      // 1ç§’å¼±ã®å½“ãŸã‚Šè¡¨ç¤ºï¼ˆé¡”+ãƒˆãƒ¼ã‚¹ãƒˆï¼‰
      const it = ITEMS[idx];
      results.push({ idx, name: it.name, emoji: it.emoji });
      showToast(`${it.emoji} ${it.name} ï¼`);
      faceImg.src = FACES[Math.floor(Math.random()*FACES.length)];
      faceOverlay.style.display = 'grid';
      playHitSFX();
      setTimeout(()=>{ faceOverlay.style.display='none'; }, 900);

      spinsLeft -= 1; setLeft(spinsLeft);
      spinning = false; document.getElementById('spin').disabled = (spinsLeft<=0);

      if(spinsLeft<=0){ showSummary(); }
    }
  }
  requestAnimationFrame(anim);
}

/* ====== ã‚µãƒãƒªãƒ¼ ====== */
function showSummary(){
  const map = new Map();
  results.forEach(r=> map.set(r.name, (map.get(r.name)||0)+1));
  const rows = [...map.entries()].map(([name,c])=>`<tr><td>${name}</td><td style="text-align:right">${c}</td></tr>`).join('');
  document.getElementById('list').innerHTML =
    `<table><thead><tr><th>ãƒ¡ãƒ‹ãƒ¥ãƒ¼</th><th style="text-align:right">æ•°é‡</th></tr></thead><tbody>${rows||'<tr><td colspan="2">ãªã—</td></tr>'}</tbody></table>`;
  document.getElementById('summary').style.display='block';
}

/* ====== UI é…ç·š ====== */
document.getElementById('spin').addEventListener('click', spin);
document.getElementById('reset').addEventListener('click', ()=>{
  stopSpinLoop(); results=[]; spinsLeft=0; setLeft('--');
  document.getElementById('summary').style.display='none';
  document.getElementById('spin').disabled=false; wheelGroup.rotation.z = currentAngle = 0;
  document.getElementById('start').style.display='grid';
});
document.getElementById('mute').addEventListener('click', ()=>{ muted=!muted; showToast(muted?'ãƒŸãƒ¥ãƒ¼ãƒˆ':'ã‚µã‚¦ãƒ³ãƒ‰ON'); });

document.getElementById('startBtn').addEventListener('click', ()=>{
  const p = Math.max(1, Math.floor(Number(document.getElementById('people').value)||0));
  spinsLeft = p*2; setLeft(spinsLeft); results=[]; document.getElementById('start').style.display='none';
  showToast(`äººæ•° ${p}äºº / åˆè¨ˆ ${spinsLeft}å›`);
});
document.getElementById('again').addEventListener('click', ()=>{
  document.getElementById('summary').style.display='none';
  document.getElementById('start').style.display='grid';
});
document.getElementById('closeSummary').addEventListener('click', ()=>{
  document.getElementById('summary').style.display='none';
});
</script>
</body>
</html>
