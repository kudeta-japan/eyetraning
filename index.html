<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Cheese Wonderland — Fullscreen Roulette</title>
<style>
  :root{ --bg:#05060a; --ink:#f6f7ff; --gold:#ffd76a; --muted:#aab0c5; --accent:#ff5a76; }
  *{box-sizing:border-box} html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,"Noto Sans JP"}
  #app{position:fixed;inset:0;display:grid;place-items:center}
  canvas{display:block;width:100vw;height:100vh}
  .hud{position:fixed;inset:0;pointer-events:none}
  .top-left{position:absolute;left:10px;top:10px;background:rgba(0,0,0,.5);padding:6px 10px;border-radius:10px;font-weight:700}
  .center{position:absolute;left:50%;bottom:8vh;transform:translateX(-50%);display:flex;gap:12px;pointer-events:auto}
  button{appearance:none;border:none;border-radius:12px;padding:12px 16px;font-weight:900;letter-spacing:.02em;cursor:pointer}
  .primary{background:linear-gradient(180deg,#ffe08a,#f7b733);color:#111;box-shadow:0 8px 24px rgba(255,208,90,.25)}
  .ghost{background:#1a1f35;color:#e9ecff;border:1px solid rgba(255,255,255,.15)}
  .toast{position:fixed;left:50%;top:14px;transform:translateX(-50%) translateY(-16px);background:#0f1330;border:1px solid rgba(255,255,255,.18);padding:10px 14px;border-radius:14px;font-weight:800;opacity:0;transition:.25s;z-index:30}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
  .result{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.65);opacity:0;pointer-events:none;transition:.35s}
  .result.show{opacity:1;pointer-events:auto}
  .card{background:#0f1431;border:1px solid rgba(255,255,255,.1);border-radius:16px;padding:18px 22px;min-width:260px}
  .card h3{margin:0 0 8px 0}
  .final-list{display:grid;grid-auto-rows:min-content;gap:6px;margin-top:10px}
  .intro{position:fixed;inset:0;display:grid;place-items:center;background:radial-gradient(900px 600px at 50% 40%, rgba(255,255,255,.08), transparent 60%)}
  .intro img{width:min(70vw,600px);border-radius:16px;box-shadow:0 18px 60px rgba(0,0,0,.45)}
  .pointer{position:fixed;left:50%;top:8px;transform:translateX(-50%);width:0;height:0;border-left:18px solid transparent;border-right:18px solid transparent;border-bottom:28px solid var(--accent);filter:drop-shadow(0 6px 12px rgba(255,90,118,.6));z-index:5}
  .ask{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.7)}
  .ask .card input{width:100%;padding:10px;border-radius:10px;background:#0b1030;color:#fff;border:1px solid rgba(255,255,255,.2)}
</style>
</head>
<body>
<div id="app"></div>
<div class="hud">
  <div class="pointer"></div>
  <div class="top-left">残り <b id="left">--</b> 回</div>
  <div class="center">
    <button id="btnSpin" class="primary">回す 🎲</button>
    <button id="btnReset" class="ghost">リセット ♻️</button>
  </div>
</div>
<div id="toast" class="toast">メッセージ</div>

<!-- 人数入力 -->
<div id="ask" class="ask">
  <div class="card">
    <h3>人数を入力</h3>
    <input id="people" type="number" min="1" step="1" value="2" />
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button id="ok" class="primary">OK</button>
    </div>
  </div>
</div>

<!-- 最終結果 -->
<div id="final" class="result">
  <div class="card">
    <h3>結果一覧</h3>
    <div id="list" class="final-list"></div>
    <div style="text-align:right;margin-top:12px"><button id="closeFinal" class="primary">閉じる</button></div>
  </div>
</div>

<!-- 表情オーバーレイ -->
<div id="intro" class="intro" style="display:none">
  <img id="faceImg" src="face.png" alt="face" />
</div>

<!-- three.js (CDN modules) -->
<script type="module">
import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
import { OrbitControls } from "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js";
import { EffectComposer } from "https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/EffectComposer.js";
import { RenderPass } from "https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/RenderPass.js";
import { UnrealBloomPass } from "https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/UnrealBloomPass.js";
import { AfterimagePass } from "https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/AfterimagePass.js";

/* ========= 設定 ========= */
// 盤面PNGの「スライス0中心」が画像のどこにあるか（度）
// 通常は「右=0°」想定。もしズレるならここを±で微調整。
const SLICE0_AT_DEG = 0;
// 針は画面上（上=90°）
const POINTER_DEG = 90;
// スライス数（画像は6分割）
const ITEMS = [
  { name:"野菜盛り",       img:"🥦" },
  { name:"牛コロカツ",     img:"🥩" },
  { name:"えびフリッター", img:"🍤" },
  { name:"ローストポーク", img:"🍖" },
  { name:"フライドチキン", img:"🍗" },
  { name:"バゲット",       img:"🥖" },
];
const N = ITEMS.length;
const ARC = 360/N;
const ALIGN = SLICE0_AT_DEG - POINTER_DEG; // 基準差

// 表情画像とSE
const FACES = ["face.png","suprised.png","happy.png","laugh.png","funny.png"];
const POP_SOUNDS = [
  new Audio("https://cdn.jsdelivr.net/gh/jun-sheep/snd@main/pop1.mp3"),
  new Audio("https://cdn.jsdelivr.net/gh/jun-sheep/snd@main/pop2.mp3"),
];
const BGM = new Audio("https://cdn.jsdelivr.net/gh/jun-sheep/snd@main/fun_bgm.mp3");
BGM.loop = true; BGM.volume = 0.25;

/* ========= DOM ========= */
const app = document.getElementById("app");
const btnSpin = document.getElementById("btnSpin");
const btnReset = document.getElementById("btnReset");
const leftEl = document.getElementById("left");
const toast = document.getElementById("toast");
const ask = document.getElementById("ask");
const peopleInput = document.getElementById("people");
const okBtn = document.getElementById("ok");
const finalDlg = document.getElementById("final");
const finalList = document.getElementById("list");
const closeFinal = document.getElementById("closeFinal");
const intro = document.getElementById("intro");
const faceImg = document.getElementById("faceImg");

/* ========= Three.js 基本 ========= */
const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
renderer.setSize(innerWidth, innerHeight);
app.appendChild(renderer.domElement);

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(35, innerWidth/innerHeight, 0.1, 100);
camera.position.set(0, 3.6, 7);
scene.add(camera);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enablePan=false; controls.enableDamping=true; controls.minPolarAngle=0.8; controls.maxPolarAngle=1.2; controls.minDistance=5.5; controls.maxDistance=8.5;

scene.add(new THREE.AmbientLight(0xffffff, .6));
const spot = new THREE.SpotLight(0xfff2cc, 1.8, 30, Math.PI/5, .5, 1.2);
spot.position.set(2.4, 6.5, 3.0); spot.target.position.set(0,0,0); scene.add(spot, spot.target);

// テーブル
const table = new THREE.Mesh(new THREE.CylinderGeometry(6.2,6.2,0.6,64),
  new THREE.MeshStandardMaterial({ color:0x1c2138, roughness:.95, metalness:.1 }));
table.position.y = -0.45; scene.add(table);

// ルーレット（円盤）
const wheelGroup = new THREE.Group(); scene.add(wheelGroup);
const loader = new THREE.TextureLoader();
const wheelTex = loader.load("roulette_ui_6_sections.png", ()=>{ renderer.render(scene,camera); });
wheelTex.anisotropy=8; wheelTex.encoding = THREE.sRGBEncoding;

const disc = new THREE.Mesh(new THREE.CircleGeometry(4.1, 256),
  new THREE.MeshStandardMaterial({ map: wheelTex, metalness:.08, roughness:.55 }));
disc.rotation.x = -0.28;
wheelGroup.add(disc);

// 縁
const rim = new THREE.Mesh(new THREE.TorusGeometry(4.12, 0.17, 32, 128),
  new THREE.MeshStandardMaterial({ color:0xd1a94a, metalness:.85, roughness:.35, envMapIntensity:1.2 }));
rim.rotation.x = -0.28; wheelGroup.add(rim);

// ポストプロセス
const composer = new EffectComposer(renderer);
composer.addPass(new RenderPass(scene, camera));
const bloom = new UnrealBloomPass(new THREE.Vector2(innerWidth, innerHeight), 0.5, 0.9, 0.2);
const afterimage = new AfterimagePass(0.88);
composer.addPass(bloom); composer.addPass(afterimage);

function resize(){
  renderer.setSize(innerWidth, innerHeight);
  composer.setSize(innerWidth, innerHeight);
  camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix();
}
addEventListener("resize", resize);

/* ========= 進行管理 ========= */
let totalSpins = 0; // ＝ 人数×2
let spinsLeft = 0;
let spinning = false;
let currentAngle = 0; // ラジアン
let selectedIndex = 0; // 抽選の「唯一の真実」
const history = []; // 当たり履歴 index

function setLeft(n){ spinsLeft=n; leftEl.textContent = String(n); }
function showToast(msg){ toast.textContent=msg; toast.classList.add("show"); setTimeout(()=>toast.classList.remove("show"), 1200); }

function showFace(ms=1400){
  faceImg.src = FACES[Math.floor(Math.random()*FACES.length)];
  POP_SOUNDS[Math.floor(Math.random()*POP_SOUNDS.length)].play().catch(()=>{});
  intro.style.display = "grid";
  setTimeout(()=>{ intro.style.display="none"; }, ms);
}

function showFinal(){
  finalList.innerHTML = "";
  history.forEach(i=>{
    const div = document.createElement("div");
    div.textContent = `${ITEMS[i].img} ${ITEMS[i].name}`;
    finalList.appendChild(div);
  });
  finalDlg.classList.add("show");
}

closeFinal.addEventListener("click", ()=> finalDlg.classList.remove("show"));

/* ========= スピン（画像を回す） ========= */
// 重要：selectedIndex を先に決め、それを**表示に使う**（停止角から再計算しない）
function spin(){
  if(spinning || spinsLeft<=0) return;
  BGM.play().catch(()=>{});
  spinning = true; btnSpin.disabled = true;

  selectedIndex = Math.floor(Math.random()*N);

  const centerDeg = selectedIndex*ARC + ARC/2;
  const jitter = (Math.random()-0.5) * (ARC * 0.35); // 35%幅で揺らす（隣に行かない程度）
  const targetDeg = 6*360 + (centerDeg + ALIGN + jitter);

  const start = currentAngle;                      // rad
  const end = start - THREE.MathUtils.degToRad(targetDeg); // 時計回りに回すのでマイナス
  const dur = 5600;
  const t0 = performance.now();

  function easeOutCubic(t){ return 1 - Math.pow(1-t, 3); }

  function anim(now){
    const t = Math.min(1, (now - t0)/dur);
    const k = easeOutCubic(t);
    const ang = start + (end - start)*k;
    wheelGroup.rotation.z = ang;
    composer.render();
    if(t<1){ requestAnimationFrame(anim); }
    else{
      currentAngle = end;
      history.push(selectedIndex);
      setLeft(spinsLeft-1);
      // 一致する当たり（selectedIndexそのもの）
      const got = ITEMS[selectedIndex];
      showToast(`当たり！ ${got.img} ${got.name}`);
      showFace(1600);
      spinning = false;
      btnSpin.disabled = spinsLeft<=0;
      if(spinsLeft<=0){ setTimeout(showFinal, 800); }
    }
  }
  requestAnimationFrame(anim);
}

/* ========= UI ========= */
btnSpin.addEventListener("click", spin);
btnReset.addEventListener("click", ()=>{
  history.length = 0;
  setLeft(0);
  showToast("リセットしました");
});
okBtn.addEventListener("click", ()=>{
  const p = Math.max(1, Math.floor(Number(peopleInput.value)||0));
  totalSpins = p * 2;
  setLeft(totalSpins);
  ask.style.display="none";
  showFace(1200);
  showToast(`${p}人 / 合計 ${totalSpins} 回`);
});

/* ========= ループ ========= */
renderer.setAnimationLoop(()=>{ controls.update(); composer.render(); });
</script>
</body>
</html>
