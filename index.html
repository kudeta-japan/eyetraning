<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Cheese Wonderland — Fullscreen Roulette (Pro)</title>
<style>
  :root{
    --bg:#080b14; --ink:#eef2ff; --panel:#0e1330;
    --gold:#f3c862; --accent:#ff5a76;
  }
  html,body{
    height:100%; margin:0;
    background:
      linear-gradient(rgba(0,0,0,0.55), rgba(0,0,0,0.55)),
      url("top.png") no-repeat center center fixed;
    background-size:cover;
    color:var(--ink);
    font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,"Noto Sans JP";
    overflow:hidden;
  }
  #stage{position:fixed;inset:0}

  /* 残り回数 */
  #leftBadge{position:fixed;left:10px;top:10px;z-index:20;background:rgba(20,24,40,.7);
    border:1px solid rgba(255,255,255,.1);padding:8px 12px;border-radius:10px;font-weight:800;backdrop-filter:blur(4px)}

  /* 操作ボタン */
  #controls{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);display:flex;gap:14px;z-index:20}
  button{appearance:none;border:none;border-radius:14px;padding:14px 22px;font-size:18px;font-weight:900;cursor:pointer;
    background:linear-gradient(180deg,#ffe08a,#f7b733);color:#141414;box-shadow:0 10px 28px rgba(0,0,0,.45)}
  button.ghost{background:#1c2342;color:#e9ecff;border:1px solid rgba(255,255,255,.14);box-shadow:none}
  button:disabled{opacity:.5;cursor:not-allowed}
  #mute{width:46px;padding:12px 0}

  /* トースト */
  #toast{position:fixed;left:50%;top:16px;transform:translateX(-50%) translateY(-16px);background:#111533;
    border:1px solid rgba(255,255,255,.18);padding:10px 14px;border-radius:12px;font-weight:800;opacity:0;
    transition:.25s;z-index:30}
  #toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

  /* 人数選択 */
  #start{position:fixed;inset:0;display:grid;place-items:center;background:rgba(5,8,16,.92);z-index:40}
  #start .card{background:linear-gradient(180deg,#161c33,#0f1330);border:1px solid rgba(255,255,255,.12);border-radius:16px;
    padding:20px;width:min(92vw,520px);box-shadow:0 24px 60px rgba(0,0,0,.6)}
  #start .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
  #start .numBtn{font-size:28px;font-weight:800;padding:22px 0;border-radius:14px;border:none;cursor:pointer;
    background:linear-gradient(180deg,#ffe08a,#f7b733);color:#141414;box-shadow:0 10px 28px rgba(0,0,0,.45);
    transition:transform .12s, box-shadow .12s}
  #start .numBtn:hover{transform:scale(1.08);box-shadow:0 12px 32px rgba(0,0,0,.55)}

  /* 顔オーバーレイ（当たり演出） */
  #faceOverlay{position:fixed;inset:0;display:none;place-items:center;background:radial-gradient(600px 420px at 50% 40%,rgba(255,255,255,.06),transparent 60%);z-index:35;pointer-events:none}
  #faceOverlay img{max-width:62vw;max-height:62vh;border-radius:16px;box-shadow:0 18px 60px rgba(0,0,0,.55);animation:pop .5s ease both}
  @keyframes pop{0%{transform:scale(.86);opacity:0}100%{transform:scale(1);opacity:1}}

  /* サマリー */
  #summary{position:fixed;inset:0;display:none;background:rgba(0,0,0,.92);z-index:50;color:#fff}
  #summary .wrap{max-width:980px;margin:60px auto;padding:0 16px}
  #summary table{width:100%;border-collapse:collapse;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);border-radius:12px;overflow:hidden}
  #summary th,#summary td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08)}
  #summary th{text-align:left;color:#aeb8ff}
  #summary tr:last-child td{border-bottom:none}

  /* LED リム */
  #ledRing{position:fixed;inset:0;pointer-events:none;display:grid;place-items:center;z-index:10}
  #ledRing .ring{position:relative;width:min(80vmin,980px);aspect-ratio:1/1;}
  #ledRing .ring .bulb{position:absolute;width:1.8%;aspect-ratio:1/1;border-radius:50%;
    background:radial-gradient(circle at 30% 30%, #fff8, #fff0 45%), radial-gradient(circle, #fbe6a4 0, #caa24a 60%, #7a5b1b 100%);
    box-shadow:0 0 8px rgba(243,200,98,.55);filter:brightness(.9)}

  /* Cong 画面（2秒だけ表示） */
  #congScreen{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.85);z-index:60}
  #congScreen img{max-width:80vmin;max-height:80vmin;border-radius:18px;box-shadow:0 24px 80px rgba(0,0,0,.6)}
</style>
</head>
<body>
<div id="stage"></div>

<!-- LED Rim -->
<div id="ledRing"><div class="ring" id="ring"></div></div>

<div id="leftBadge">残り <b id="leftNum">--</b> 回</div>

<div id="controls">
  <button id="spin">回す 🎡</button>
  <button id="stop" class="ghost" disabled>止める ⏹</button>
  <button id="mute" class="ghost" title="ミュート切替">🔈</button>
  <button id="reset" class="ghost">リセット 🔄</button>
</div>

<div id="toast">当たり！</div>

<!-- 人数選択 -->
<div id="start">
  <div class="card">
    <h2 style="margin:0 0 14px;text-align:center">人数を選んでください</h2>
    <div class="grid">
      <button class="numBtn" data-p="1">1</button>
      <button class="numBtn" data-p="2">2</button>
      <button class="numBtn" data-p="3">3</button>
      <button class="numBtn" data-p="4">4</button>
      <button class="numBtn" data-p="5">5</button>
      <button class="numBtn" data-p="6">6</button>
    </div>
    <div style="opacity:.7;margin-top:14px;text-align:center">※ 1人2回プレイ</div>
  </div>
</div>

<!-- Cong 画面 -->
<div id="congScreen"><img src="cong.png" alt="Congratulations"></div>

<!-- 顔オーバーレイ -->
<div id="faceOverlay"><img id="faceImg" alt=""></div>

<!-- 結果サマリー -->
<div id="summary">
  <div class="wrap">
    <h2>結果まとめ</h2>
    <div id="list"></div>
    <div style="margin-top:14px;display:flex;gap:10px">
      <button id="again">もう一度</button>
      <button id="closeSummary" class="ghost">閉じる</button>
    </div>
  </div>
</div>

<!-- three.js -->
<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script>
/* ========= 便利関数 ========= */
const TAU=Math.PI*2;
const deg=d=>THREE.MathUtils.degToRad(d);
const radToDeg=r=>THREE.MathUtils.radToDeg(r);
const norm=a=>THREE.MathUtils.euclideanModulo(a,TAU);
const toClockDeg=mathDeg=>(90-mathDeg+360)%360;
const toMathDeg =clockDeg=>(90-clockDeg+360)%360;

/* ========= アイテム（角度マッピング） ========= */
const ITEMS=[
  {name:"牛コロカツ",emoji:"🥩",centerClock:60},
  {name:"えびフリッター",emoji:"🍤",centerClock:120},
  {name:"ローストポーク",emoji:"🍖",centerClock:180},
  {name:"フライドチキン",emoji:"🍗",centerClock:240},
  {name:"バゲット",emoji:"🥖",centerClock:300},
  {name:"野菜盛り合わせ",emoji:"🥦",centerClock:0},
];
const FACE_MAP = {
  "牛コロカツ": ["funny.png"],
  "えびフリッター": ["happy.png"],
  "ローストポーク": ["kazuma.png"],
  "フライドチキン": ["suprised.png"],
  "バゲット": ["sora.png"],          // ← バゲットは必ず sora.png
  "野菜盛り合わせ": ["happy.png"],
};

// 選択関数（1要素なら必ずそれが返る）
function faceFor(name){
  const list = FACE_MAP[name] || ["face.png"];
  return list[Math.floor(Math.random() * list.length)];
}

/* ========= 状態とDOM ========= */
let spinsLeft=0, spinning=false;
let pointerAngle=0;  // 数学角(rad)
let results=[];
const leftNum=document.getElementById('leftNum');
const toast=document.getElementById('toast');
const faceOverlay=document.getElementById('faceOverlay');
const faceImg=document.getElementById('faceImg');
const congScreen=document.getElementById('congScreen');
const setLeft=n=>leftNum.textContent=n;
const showToast=m=>{toast.textContent=m;toast.classList.add('show');setTimeout(()=>toast.classList.remove('show'),1100);};

/* ========= LED（外側） ========= */
const LED_RADIUS_PCT=49.5;
const ledBulbs=[];
(function makeLED(){
  const ring=document.getElementById('ring'); const bulbs=64;
  for(let i=0;i<bulbs;i++){
    const b=document.createElement('div'); b.className='bulb';
    const aMath=i/bulbs*360;
    b.style.left=(50+LED_RADIUS_PCT*Math.cos(deg(aMath)))+'%';
    b.style.top =(50+LED_RADIUS_PCT*Math.sin(deg(aMath)))+'%';
    ring.appendChild(b); ledBulbs.push({el:b,aMath});
  }
})();
let ledPhase=0, ledSpeed=0.6, ledState='idle';
function setLEDIdle(){ledState='idle';ledSpeed=.6;highlightNone();}
function setLEDSpin(speed){ledState='spin';ledSpeed=4*Math.min(1,speed);}
function setLEDWin(centerClock){ledState='win';highlightSectorClock(centerClock,30);setTimeout(()=>setLEDIdle(),1400);}
function highlightNone(){ledBulbs.forEach(({el})=>{el.style.boxShadow="0 0 8px rgba(243,200,98,.55)";el.style.filter='brightness(.9)';});}
function highlightSectorClock(centerClock,half){
  const minC=(centerClock-half+360)%360, maxC=(centerClock+half+360)%360;
  ledBulbs.forEach(({el,aMath})=>{
    const aClock=(90-aMath+360)%360;
    const inArc=(minC<maxC)?(aClock>=minC&&aClock<=maxC):(aClock>=minC||aClock<=maxC);
    el.style.boxShadow=inArc?"0 0 20px 6px rgba(255,230,160,.95), 0 0 6px rgba(255,230,160,.9)":"0 0 6px rgba(243,200,98,.45)";
    el.style.filter=inArc?"brightness(1.6)":"brightness(.9)";
  });
}
function stepLED(dt){
  if(ledState==='idle'||ledState==='spin'){
    ledPhase=(ledPhase+dt*ledSpeed)%1;
    ledBulbs.forEach(({el,aMath})=>{
      const a=aMath/360; const k=Math.max(0,Math.cos((a-ledPhase)*Math.PI*2*4));
      el.style.filter=`brightness(${0.6+0.4*k})`;
      el.style.boxShadow=`0 0 ${8+12*k}px rgba(243,200,98,${.35+.45*k})`;
    });
  }
}

/* ========= Three.js ========= */
const stage=document.getElementById('stage');
const renderer=new THREE.WebGLRenderer({antialias:true,alpha:true});
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
renderer.setSize(innerWidth,innerHeight);
stage.appendChild(renderer.domElement);
let camera; const scene=new THREE.Scene();

/* 盤 */
const loader=new THREE.TextureLoader();
const tex=loader.load('roulette_ui_6_sections.png'); tex.colorSpace=THREE.SRGBColorSpace;
const wheel=new THREE.Mesh(new THREE.PlaneGeometry(1,1), new THREE.MeshBasicMaterial({map:tex,transparent:true}));
scene.add(wheel);

/* 針（クラシック矢印・視認性UP） */
const pointerGroup=new THREE.Group(); scene.add(pointerGroup);
const pointerAnchor=new THREE.Group(); pointerGroup.add(pointerAnchor);

function makeGlowSprite(px=420,rgba='rgba(255,80,120,1)'){
  const c=document.createElement('canvas'); c.width=c.height=px; const g=c.getContext('2d');
  const grd=g.createRadialGradient(px/2,px/2,0,px/2,px/2,px/2);
  grd.addColorStop(0,rgba.replace('1)','0.55)')); grd.addColorStop(1,rgba.replace('1)','0)'));
  g.fillStyle=grd; g.fillRect(0,0,px,px);
  const t=new THREE.CanvasTexture(c); t.colorSpace=THREE.SRGBColorSpace;
  return new THREE.Sprite(new THREE.SpriteMaterial({map:t,transparent:true,blending:THREE.AdditiveBlending,depthWrite:false}));
}
function buildPointer(){
  const g=new THREE.Group();
  const base=new THREE.CylinderGeometry(0.16,0.2,0.06,48);
  const baseMesh=new THREE.Mesh(base,new THREE.MeshPhysicalMaterial({color:0xb39a5a,metalness:1,roughness:.2,clearcoat:1,clearcoatRoughness:.12}));
  baseMesh.position.set(0,-0.03,0); g.add(baseMesh);

  // 白×金で視認性アップ
  const shaft=new THREE.Mesh(new THREE.BoxGeometry(0.06,0.30,0.05),
    new THREE.MeshPhysicalMaterial({color:0xffffff,metalness:.6,roughness:.2,clearcoat:1}));
  shaft.position.y=0.10; g.add(shaft);

  const head=new THREE.Mesh(new THREE.ConeGeometry(0.13,0.24,40),
    new THREE.MeshPhysicalMaterial({color:0xff5757,emissive:0x551111,emissiveIntensity:.6,metalness:.2,roughness:.25,clearcoat:1}));
  head.rotation.z=Math.PI; head.position.y=0.42; g.add(head);

  const tip=new THREE.Mesh(new THREE.SphereGeometry(0.034,24,24),
    new THREE.MeshStandardMaterial({color:0xffffff,emissive:0xfff2c0,emissiveIntensity:1.2,metalness:.1,roughness:.2}));
  tip.position.y=0.53; g.add(tip);

  const glow=makeGlowSprite(520,'rgba(255,160,120,1)'); glow.position.set(0,0.53,0.02); glow.scale.set(0.5,0.5,1);
  g.add(glow);
  return g;
}
pointerAnchor.add(buildPointer());

function fit(){
  const w=innerWidth,h=innerHeight;
  renderer.setSize(w,h);
  camera=new THREE.OrthographicCamera(-w/2,w/2,h/2,-h/2,-10,10);
  camera.position.set(0,0,5); camera.lookAt(0,0,0);

  const size=Math.min(w,h)*0.86;
  wheel.scale.set(size,size,1);

  const pointerScale=size*0.22;
  pointerGroup.scale.set(pointerScale,pointerScale,pointerScale);
  pointerGroup.position.set(0,0,0);
  const offset=size*0.40/pointerScale;
  pointerAnchor.position.set(0,offset,0);

  pointerGroup.rotation.z=pointerAngle=0;
}
addEventListener('resize',fit); fit();

/* ========= オーディオ（カーニバルBGM） ========= */
let audioCtx, master, loopTimer, muted=false, bgmNode;
function ensureAudio(){
  if(audioCtx) return;
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  master=audioCtx.createGain(); master.gain.value=.48; master.connect(audioCtx.destination);

  function startBGM(){
    if(muted) return; stopBGM();
    const bpm=120, beat=60/bpm;
    bgmNode=setInterval(()=>{
      const t0=audioCtx.currentTime;
      for(let step=0; step<8; step++){
        const t=t0+step*beat/2;

        // 🎺 トランペット風（sawtooth + スタッカート）
        const melody=[523,659,784,880][step%4]; // C E G A
        const o=audioCtx.createOscillator(); o.type='sawtooth'; o.frequency.value=melody;
        const g=audioCtx.createGain(); g.gain.value=0.0001; o.connect(g).connect(master);
        o.start(t);
        g.gain.setValueAtTime(0.0001,t);
        g.gain.exponentialRampToValueAtTime(0.18,t+0.05);
        g.gain.exponentialRampToValueAtTime(0.0001,t+beat/2-0.05);
        o.stop(t+beat/2);

        // 🥁 スネア風ノイズ（裏拍で）
        if(step%2===0){
          const n=audioCtx.createBufferSource();
          const buf=audioCtx.createBuffer(1, audioCtx.sampleRate*0.12, audioCtx.sampleRate);
          const ch=buf.getChannelData(0);
          for(let i=0;i<ch.length;i++) ch[i]=Math.random()*2-1;
          n.buffer=buf;
          const g2=audioCtx.createGain(); g2.gain.value=0.14;
          const hp=audioCtx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=1800;
          n.connect(hp).connect(g2).connect(master);
          n.start(t+beat/4);
        }

        // 🎶 ベース（チューバっぽく）
        const b=audioCtx.createOscillator(); b.type='square'; b.frequency.value=[130.81,164.81][step%2]; // C3 / E3
        const gb=audioCtx.createGain(); gb.gain.value=0.0001; b.connect(gb).connect(master);
        b.start(t);
        gb.gain.setValueAtTime(0.0001,t);
        gb.gain.exponentialRampToValueAtTime(0.12,t+0.04);
        gb.gain.exponentialRampToValueAtTime(0.0001,t+beat/2);
        b.stop(t+beat/2);
      }
    }, beat*1000*4);
  }
  function stopBGM(){ if(bgmNode){ clearInterval(bgmNode); bgmNode=null; } }
  ensureAudio.startBGM=startBGM; ensureAudio.stopBGM=stopBGM;
}
function startSpinLoop(){
  if(muted) return; ensureAudio(); stopSpinLoop();
  loopTimer=setInterval(()=>{
    const freqs=[523.25,659.25,783.99];
    freqs.forEach((f,i)=>{
      const t=audioCtx.currentTime+i*0.08;
      const o=audioCtx.createOscillator(); o.type='triangle'; o.frequency.value=f;
      const g=audioCtx.createGain(); g.gain.value=0.0001; o.connect(g).connect(master);
      o.start(t); g.gain.setValueAtTime(0.0001,t);
      g.gain.exponentialRampToValueAtTime(0.22,t+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001,t+0.15);
      o.stop(t+0.16);
    });
  },260);
}
function stopSpinLoop(){ if(loopTimer){ clearInterval(loopTimer); loopTimer=null; } }
function playHitSFX(){
  if(muted) return; ensureAudio();
  const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
  o.type='square'; o.frequency.setValueAtTime(880, audioCtx.currentTime);
  g.gain.value=0.0001; o.connect(g).connect(master); o.start();
  const t=audioCtx.currentTime;
  g.gain.exponentialRampToValueAtTime(0.35,t+0.01);
  o.frequency.exponentialRampToValueAtTime(1760,t+0.12);
  g.gain.exponentialRampToValueAtTime(0.0001,t+0.28);
  o.stop(t+0.30);
}

/* ========= 判定 ========= */
const JUDGE_OFFSET_CLOCK=-90; // ずれ補正（必要に応じ±90を切替）
function clockDegFromRad(rad){
  const mathDeg=(radToDeg(rad)%360+360)%360;
  return ((90-mathDeg+360)%360 + JUDGE_OFFSET_CLOCK + 360)%360;
}
function itemIdxByClockDeg(a){
  const d=((a%360)+360)%360;
  if(d>=30 && d<90)   return 0;
  if(d>=90 && d<150)  return 1;
  if(d>=150 && d<210) return 2;
  if(d>=210 && d<270) return 3;
  if(d>=270 && d<330) return 4;
  return 5;
}
function idxByAngleRad(rad){ return itemIdxByClockDeg(clockDegFromRad(rad)); }
function targetAngleForIdx(idx){ return deg(toMathDeg(ITEMS[idx].centerClock)); }
function faceFor(name){ return FACE_MAP[name] || "face.png"; }

/* ========= スピン制御 ========= */
let omega=0, spinMode='idle';
const OMEGA_MAX=10, ACCEL=16;
let stopStartAngle=0, stopTargetAngle=0, stopElapsed=0, stopDuration=3.0;
const shortestDelta=(from,to)=>{let d=norm(to)-norm(from); if(d>Math.PI) d-=TAU; if(d<-Math.PI) d+=TAU; return d;};

function startSpin(){
  if(spinning||spinsLeft<=0) return;
  spinning=true;
  document.getElementById('spin').disabled=true;
  document.getElementById('stop').disabled=false;

  ensureAudio(); ensureAudio.startBGM?.();
  startSpinLoop();

  spinMode='spin'; omega=0.0001; setLEDSpin(0.2);
}
function pressStop(){
  if(spinMode!=='spin') return;
  spinMode='stoppingTween';
  stopSpinLoop();

  const nowA=norm(pointerGroup.rotation.z);
  const idx=idxByAngleRad(nowA);
  const centerTgt=targetAngleForIdx(idx);

  // 区画内のランダム位置に着地
  const jitter=(Math.random()*2-1)*deg(30); // ±30°
  const tgt=centerTgt + jitter;

  const laps=4+Math.floor(Math.random()*3); // 4〜6周
  stopStartAngle=nowA;
  stopTargetAngle=nowA + laps*TAU + shortestDelta(nowA, tgt);
  stopElapsed=0;
  stopDuration=2.7 + Math.random()*0.6;
}
function finishStop(){
  pointerGroup.rotation.z=norm(stopTargetAngle);
  pointerAngle=pointerGroup.rotation.z;
  spinMode='idle'; omega=0; setLEDIdle();

  const idx=idxByAngleRad(pointerAngle);
  const it=ITEMS[idx];
  results.push({idx,name:it.name,emoji:it.emoji});

  faceImg.src=faceFor(it.name);
  faceOverlay.style.display='grid';
  playHitSFX(); showToast(`${it.emoji} ${it.name}！`);
  setLEDWin(ITEMS[idx].centerClock);
  setTimeout(()=>{faceOverlay.style.display='none';},1700);

  spinsLeft-=1; setLeft(spinsLeft);
  spinning=false;
  document.getElementById('spin').disabled=(spinsLeft<=0);
  document.getElementById('stop').disabled=true;

  if(spinsLeft<=0){
    // Cong 画面を2秒表示 → サマリーへ
    congScreen.style.display='flex';
    setTimeout(()=>{
      congScreen.style.display='none';
      showSummary();
    },2000);
  }
}
function stepSpin(dt){
  if(spinMode==='idle') return;
  if(spinMode==='spin'){
    omega=Math.min(OMEGA_MAX, omega+ACCEL*dt);
    pointerGroup.rotation.z=norm(pointerGroup.rotation.z + omega*dt);
    setLEDSpin(omega/OMEGA_MAX);
    return;
  }
  if(spinMode==='stoppingTween'){
    stopElapsed+=dt;
    const t=Math.min(1, stopElapsed/stopDuration);
    const ease=1-Math.pow(1-t,3); // easeOutCubic
    const total=stopTargetAngle - stopStartAngle;
    pointerGroup.rotation.z=norm(stopStartAngle + total*ease);
    setLEDSpin(1 - t*0.95);
    if(t>=1) finishStop();
  }
}

/* ========= サマリー ========= */
function showSummary(){
  const map=new Map();
  results.forEach(r=>map.set(r.name,(map.get(r.name)||0)+1));
  const rows=[...map.entries()].map(([n,c])=>`<tr><td>${n}</td><td style="text-align:right">${c}</td></tr>`).join('');
  document.getElementById('list').innerHTML =
    `<table><thead><tr><th>メニュー</th><th style="text-align:right">数量</th></tr></thead><tbody>${rows||'<tr><td colspan="2">なし</td></tr>'}</tbody></table>`;
  document.getElementById('summary').style.display='block';
}

/* ========= レンダリング ========= */
let last=performance.now();
function render(){
  const now=performance.now(); const dt=Math.min(0.05,(now-last)/1000); last=now;
  stepSpin(dt); stepLED(dt);
  wheel.rotation.z=0;
  renderer.render(scene,camera);
  requestAnimationFrame(render);
}
render();

/* ========= UI ========= */
document.getElementById('spin').addEventListener('click', startSpin);
document.getElementById('stop').addEventListener('click', pressStop);
document.getElementById('reset').addEventListener('click', ()=>{
  stopSpinLoop(); ensureAudio?.stopBGM?.();
  results=[]; spinsLeft=0; setLeft('--');
  document.getElementById('summary').style.display='none';
  document.getElementById('spin').disabled=false;
  document.getElementById('stop').disabled=true;
  pointerGroup.rotation.z=pointerAngle=0;
  spinMode='idle'; setLEDIdle();
  document.getElementById('start').style.display='grid';
});
document.getElementById('mute').addEventListener('click', ()=>{
  muted=!muted; showToast(muted?'ミュート':'サウンドON');
});

/* 人数ボタンでスタート */
document.querySelectorAll('.numBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const p=Number(btn.dataset.p);
    spinsLeft=p*2; setLeft(spinsLeft); results=[];
    document.getElementById('start').style.display='none';
    ensureAudio(); ensureAudio.startBGM?.();
    showToast(`人数 ${p}人 / 合計 ${spinsLeft}回`);
  });
});

/* サマリー後の操作 */
document.getElementById('again').addEventListener('click', ()=>{
  document.getElementById('summary').style.display='none';
  document.getElementById('start').style.display='grid';
});
document.getElementById('closeSummary').addEventListener('click', ()=>{
  document.getElementById('summary').style.display='none';
});
</script>
</body>
</html>
