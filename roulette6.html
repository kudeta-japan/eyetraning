<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Cheese Wonderland â€” 3D Roulette (Three.js)</title>
<style>
  :root{ --bg:#0a0b14; --ink:#f6f7ff; --muted:#a8b1d9; --gold:#ffe08a; --accent:#ff5a76; }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 80% -10%, rgba(255,255,255,.06), transparent 60%), var(--bg); color:var(--ink); font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,"Noto Sans JP"}
  header{position:sticky;top:0;z-index:50;display:flex;gap:12px;align-items:center;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg,rgba(255,255,255,.035),transparent)}
  .tag{background:var(--gold);color:#111;padding:4px 8px;border-radius:999px;font-weight:900;font-size:12px}
  h1{margin:0;font-size:clamp(18px,3.2vw,28px)}
  main{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;padding:16px}
  @media (max-width:980px){main{grid-template-columns:1fr}}
  .panel{background:radial-gradient(700px 300px at 100% 0, rgba(255,255,255,.05), transparent 40%), #12152a;border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px;position:relative;overflow:hidden}
  .stage{position:relative;aspect-ratio:1/1;min-height:420px;border-radius:12px;overflow:hidden}
  canvas.fx{position:absolute;inset:0;pointer-events:none;z-index:6}
  .pointer{position:absolute;left:50%;top:8px;transform:translateX(-50%);width:0;height:0;border-left:18px solid transparent;border-right:18px solid transparent;border-bottom:28px solid var(--accent);filter:drop-shadow(0 6px 12px rgba(255,90,118,.6));z-index:7}
  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:8px 0 12px}
  .group{display:flex;gap:8px;align-items:center;background:#0b1030;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:8px 10px}
  label{font-size:12px;color:var(--muted)}
  input[type="number"],input[type="file"]{background:#0a0e24;color:#f6f7ff;border:1px solid rgba(255,255,255,.16);border-radius:10px;padding:8px 10px;font-size:14px}
  button{appearance:none;border:none;border-radius:12px;background:linear-gradient(180deg,#ffe08a,#f7b733);color:#151515;font-weight:900;letter-spacing:.02em;padding:10px 14px;cursor:pointer;box-shadow:0 8px 24px rgba(255,208,90,.25), inset 0 1px 0 rgba(255,255,255,.5)}
  button.ghost{background:#222848;color:#f6f7ff;border:1px solid rgba(255,255,255,.12);box-shadow:none}
  .mini{font-size:12px;color:var(--muted)}
  .weights .row{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;padding:8px;margin-bottom:8px;background:#0b1030;border:1px solid rgba(255,255,255,.08);border-radius:12px}
  .weights input[type="range"]{width:160px}
  .orders table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.08);font-size:14px}
  .toast{position:fixed;left:50%;top:14px;transform:translateX(-50%) translateY(-16px);background:#111533;color:#f6f7ff;border:1px solid rgba(255,255,255,.14);padding:10px 14px;border-radius:14px;font-weight:800;opacity:0;transition:.25s;z-index:200}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>
<header><span class="tag">Cheese Wonderland</span><h1>3D Roulette â€” Three.js</h1></header>

<main>
  <section class="panel">
    <div class="controls">
      <div class="group">
        <label>äººæ•°</label>
        <input type="number" id="people" min="1" step="1" value="2">
        <button id="apply">è¨­å®š</button>
        <span class="mini">æ®‹ã‚Š <b id="spinsLeft">--</b> å›</span>
      </div>
      <div class="group">
        <button id="spin">å›ã™</button>
        <button id="undo" class="ghost">ä¸€æ‰‹æˆ»ã™</button>
        <button id="reset" class="ghost">ãƒªã‚»ãƒƒãƒˆ</button>
        <span class="mini">Fã§å…¨ç”»é¢</span>
      </div>
      <div class="group">
        <input type="file" id="texFile" accept="image/*">
        <span class="mini">ç›¤é¢ç”»åƒã‚’å·®ã—æ›¿ãˆ</span>
      </div>
    </div>

    <div class="stage" id="stage">
      <div class="pointer"></div>
      <canvas class="fx" id="fx"></canvas>
    </div>
  </section>

  <section class="panel">
    <h3>ç¢ºç‡ï¼ˆé‡ã¿ï¼‰</h3>
    <div id="weights" class="weights"></div>
  </section>

  <section class="panel orders">
    <h3>æ³¨æ–‡ãƒªã‚¹ãƒˆ</h3>
    <table>
      <thead><tr><th style="text-align:left;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼</th><th>ç¢ºç‡</th><th style="text-align:right;">æ•°é‡</th></tr></thead>
      <tbody id="orderBody"></tbody>
    </table>
  </section>
</main>

<div class="toast" id="toast">è¨­å®šã—ã¾ã—ãŸ</div>

<!-- Three.js + postprocessing (CDN) -->
<script type="module">
import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
import { OrbitControls } from "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js";
import { EffectComposer } from "https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/EffectComposer.js";
import { RenderPass } from "https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/RenderPass.js";
import { UnrealBloomPass } from "https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/UnrealBloomPass.js";
import { AfterimagePass } from "https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/AfterimagePass.js";

/* ====== ãƒ‡ãƒ¼ã‚¿ï¼ˆ6ç­‰åˆ†ãƒ»ãƒã‚¹ã‚¯ç„¡ã—ï¼‰ ====== */
const ITEMS = [
  { name:"ãˆã³ãƒ•ãƒªãƒƒã‚¿ãƒ¼", emoji:"ğŸ¤", weight:12 },
  { name:"ãƒ­ãƒ¼ã‚¹ãƒˆãƒãƒ¼ã‚¯", emoji:"ğŸ–", weight:12 },
  { name:"ãƒ•ãƒ©ã‚¤ãƒ‰ãƒã‚­ãƒ³", emoji:"ğŸ—", weight:13 },
  { name:"ãƒã‚²ãƒƒãƒˆ",       emoji:"ğŸ¥–", weight:15 },
  { name:"é‡èœç››ã‚Š",       emoji:"ğŸ¥¦", weight:13 },
  { name:"ç‰›ã‚³ãƒ­ã‚«ãƒ„",     emoji:"ğŸ¥©", weight:13 },
];
const N = ITEMS.length, ARC = 360/N;

/* ====== DOM ====== */
const stage = document.getElementById("stage");
const toast = document.getElementById("toast");
const weightsEl = document.getElementById("weights");
const orderBody = document.getElementById("orderBody");
const texFile = document.getElementById("texFile");
const fx = document.getElementById("fx");
let spinsLeft = 0, spinning = false, history = [], currentAngle = 0;

/* ====== Three.js åŸºæœ¬ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ====== */
const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
renderer.setSize(stage.clientWidth, stage.clientHeight);
stage.appendChild(renderer.domElement);

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(35, stage.clientWidth/stage.clientHeight, 0.1, 100);
camera.position.set(0, 3.8, 6.5);
scene.add(camera);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true; controls.enablePan = false; controls.minDistance = 5; controls.maxDistance = 10; controls.minPolarAngle = 0.8; controls.maxPolarAngle = 1.2;

/* ç’°å¢ƒå…‰ï¼‹ã‚¹ãƒãƒƒãƒˆ */
scene.add(new THREE.AmbientLight(0xffffff, .55));
const spot = new THREE.SpotLight(0xfff2cc, 1.8, 25, Math.PI/5, .5, 1.2);
spot.position.set(2.4, 6.2, 3.0); spot.target.position.set(0,0,0);
scene.add(spot, spot.target);

/* ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ§ãˆã‚ï¼‰ */
const table = new THREE.Mesh(new THREE.CylinderGeometry(5,5,0.5,64), new THREE.MeshStandardMaterial({ color:0x202338, metalness:.2, roughness:.9 }));
table.position.y = -0.35; scene.add(table);

/* ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆï¼šä¸Šé¢ãƒ†ã‚¯ã‚¹ãƒãƒ£ï¼ˆCircleï¼‰ï¼‹ç¸ï¼ˆTorusï¼‰ */
const wheelGroup = new THREE.Group(); scene.add(wheelGroup);
const loader = new THREE.TextureLoader();

/* ğŸ‘‡ ã“ã“ãŒä»Šå›ã®å¤‰æ›´ç‚¹ï¼šæ—¢å®šãƒ†ã‚¯ã‚¹ãƒãƒ£ã« â€œroulette_ui_6_sections.jpegâ€ ã‚’ä½¿ç”¨ */
let wheelTex = loader.load("roulette_ui_6_sections.jpeg"); // åŒãƒ•ã‚©ãƒ«ãƒ€ã«ç½®ã
wheelTex.anisotropy = 8; wheelTex.colorSpace = THREE.SRGBColorSpace;

const disc = new THREE.Mesh(
  new THREE.CircleGeometry(3.2, 256),
  new THREE.MeshStandardMaterial({ map: wheelTex, metalness:.05, roughness:.55 })
);
disc.rotation.x = -0.28; // å¥¥ã«å°‘ã—å€’ã™
wheelGroup.add(disc);

const rim = new THREE.Mesh(
  new THREE.TorusGeometry(3.22, 0.14, 32, 128),
  new THREE.MeshStandardMaterial({ color:0xd1a94a, metalness:.85, roughness:.35, envMapIntensity:1.2 })
);
rim.rotation.x = -0.28; wheelGroup.add(rim);

/* ä¸­å¤®ã®èµ¤ã„å™¨ã£ã½ã„ãƒãƒ–ï¼ˆç«‹ä½“æ„Ÿï¼‰ */
const knob = new THREE.Mesh(
  new THREE.CylinderGeometry(0.5,0.7,0.35,64),
  new THREE.MeshStandardMaterial({ color:0xb90e2d, metalness:.3, roughness:.45, emissive:0x300000, emissiveIntensity:.25 })
);
knob.position.set(0, 0.02, 0); knob.rotation.x = -0.28; wheelGroup.add(knob);

/* ãƒã‚¹ãƒˆãƒ—ãƒ­ã‚»ã‚¹ï¼ˆãƒ–ãƒ«ãƒ¼ãƒ ï¼‹æ®‹åƒï¼‰ */
const composer = new EffectComposer(renderer);
composer.addPass(new RenderPass(scene, camera));
const bloom = new UnrealBloomPass(new THREE.Vector2(stage.clientWidth, stage.clientHeight), 0.6, 0.9, 0.2);
const afterimage = new AfterimagePass(0.88);
composer.addPass(bloom); composer.addPass(afterimage);

/* ãƒªã‚µã‚¤ã‚º */
function onResize(){
  const w = stage.clientWidth, h = stage.clientHeight;
  renderer.setSize(w, h); composer.setSize(w, h);
  camera.aspect = w/h; camera.updateProjectionMatrix();
  resizeFX();
}
new ResizeObserver(onResize).observe(stage); onResize();

/* ====== ç›¤é¢ãƒ†ã‚¯ã‚¹ãƒãƒ£å·®ã—æ›¿ãˆï¼ˆãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ï¼‰ ====== */
texFile.addEventListener("change", e=>{
  const f = e.target.files[0]; if(!f) return;
  const url = URL.createObjectURL(f);
  const tex = loader.load(url, ()=>{
    disc.material.map = tex;
    disc.material.needsUpdate = true;
    showToast("ç›¤é¢ã‚’å·®ã—æ›¿ãˆã¾ã—ãŸ");
  });
  tex.anisotropy = 8; tex.colorSpace = THREE.SRGBColorSpace;
});

/* ====== UIï¼šç¢ºç‡ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ ====== */
function pct(w){ const t = ITEMS.reduce((s,i)=>s+Number(i.weight||0),0); return t? (w/t*100) : 0; }
function buildWeights(){
  weightsEl.innerHTML = "";
  ITEMS.forEach(it=>{
    const row = document.createElement("div"); row.className="row";
    const left = document.createElement("div"); left.textContent = `${it.emoji} ${it.name}ï¼ˆâ‰ˆ ${pct(it.weight).toFixed(1)}%ï¼‰`;
    const right = document.createElement("div"); right.style.display="flex"; right.style.gap="8px"; right.style.alignItems="center";
    const rng = document.createElement("input"); rng.type="range"; rng.min=0; rng.max=40; rng.value=it.weight;
    const num = document.createElement("input"); num.type="number"; num.min=0; num.max=200; num.value=it.weight; num.style.width="70px";
    const sync=()=>{ it.weight=Number(num.value||0); rng.value=String(it.weight); buildWeights(); refreshOrders(); };
    rng.addEventListener("input", ()=>{ num.value=rng.value; sync(); }); num.addEventListener("input", sync);
    right.append(rng,num); row.append(left,right); weightsEl.append(row);
  });
}

/* ====== æ³¨æ–‡é›†è¨ˆ ====== */
function refreshOrders(){
  orderBody.innerHTML = "";
  const counts = new Map(); history.forEach(i=>counts.set(i,(counts.get(i)||0)+1));
  const tot = ITEMS.reduce((s,i)=>s+Number(i.weight||0),0);
  ITEMS.forEach((s,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${s.emoji} ${s.name}</td><td>â‰ˆ ${(tot?(s.weight/tot*100):0).toFixed(1)}%</td><td style="text-align:right;">${counts.get(i)||0}</td>`;
    orderBody.appendChild(tr);
  });
  document.getElementById("spinsLeft").textContent = spinsLeft;
}

/* ====== ãã˜ãƒ­ã‚¸ãƒƒã‚¯ ====== */
function weightedPick(){
  const tot = ITEMS.reduce((s,i)=>s+Number(i.weight||0),0) || 1;
  let r = Math.random()*tot;
  for(let i=0;i<N;i++){ r -= Number(ITEMS[i].weight||0); if(r<=0) return i; }
  return N-1;
}
function showToast(msg){ toast.textContent = msg; toast.classList.add("show"); setTimeout(()=>toast.classList.remove("show"), 1200); }

/* ====== å›ã™ï¼ˆæ¸›é€Ÿã‚¤ãƒ¼ã‚¸ãƒ³ã‚°ï¼‹SEï¼‹ç´™å¹é›ªï¼‰ ====== */
function spin(){
  if(spinning || spinsLeft<=0) return;
  spinning = true; document.getElementById("spin").disabled = true;

  const idx = weightedPick();
  // ç”»åƒã¯å³=0Â°åŸºæº–ã€ã‚¹ãƒ©ã‚¤ã‚¹ä¸­å¿ƒ = idx*ARC + ARC/2ã€ãƒã‚¤ãƒ³ã‚¿ã¯ä¸Š=90Â° â†’ center - 90 ãŒç›®æ¨™è§’
  const center = idx*ARC + ARC/2;
  const jitter = (Math.random()*ARC*0.2) - (ARC*0.1);
  const deltaDeg = -(6*360 + (center - 90) + jitter); // 6å›è»¢ï¼‹ç›®æ¨™
  const start = currentAngle;
  const end = currentAngle + THREE.MathUtils.degToRad(deltaDeg);
  const dur = 5600;
  const t0 = performance.now();
  tickSoundStart();

  function easeOutCubic(t){ return 1 - Math.pow(1-t, 3); }
  function anim(now){
    const t = Math.min(1, (now - t0)/dur);
    const k = easeOutCubic(t);
    const ang = start + (end - start)*k;
    wheelGroup.rotation.z = ang;
    renderer.setAnimationLoop(render);
    if(t<1){ requestAnimationFrame(anim); }
    else{
      currentAngle = end;
      tickSoundStop();
      burstParticles();
      history.push(idx); spinsLeft -= 1; refreshOrders();
      spinning = false; document.getElementById("spin").disabled = spinsLeft<=0;
    }
  }
  requestAnimationFrame(anim);
}

/* ====== WebAudioï¼šãƒã‚¯ã‚¿ã‚¯SE ====== */
let audioCtx, tickTimer;
function tick(){
  if(!audioCtx) return;
  const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
  o.type="square"; o.frequency.value = 1200 + Math.random()*300;
  g.gain.value = 0.0001; o.connect(g); g.connect(audioCtx.destination);
  o.start();
  const now = audioCtx.currentTime;
  g.gain.exponentialRampToValueAtTime(0.14, now + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, now + 0.08);
  o.stop(now + 0.09);
}
function tickSoundStart(){
  audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
  let interval = 80; clearInterval(tickTimer); tickTimer = setInterval(tick, interval);
  let t=0; const id = setInterval(()=>{ t+=1; interval = Math.min(220, 80 + t*4); clearInterval(tickTimer); tickTimer = setInterval(tick, interval); if(interval>=220) clearInterval(id); }, 260);
}
function tickSoundStop(){ clearInterval(tickTimer); }

/* ====== ç´™å¹é›ªï¼ˆ2D Canvasï¼‰ ====== */
const ctx = fx.getContext("2d");
function resizeFX(){
  const r = stage.getBoundingClientRect();
  fx.width = Math.max(1, Math.floor(r.width * devicePixelRatio));
  fx.height = Math.max(1, Math.floor(r.height * devicePixelRatio));
}
let particles = [];
function burstParticles(){
  const cx = fx.width/2, cy = fx.height*0.38;
  for(let i=0;i<180;i++){
    const a = Math.random()*Math.PI*2, sp = 3 + Math.random()*5;
    particles.push({ x:cx, y:cy, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp, life:60+Math.random()*40, col:`hsl(${10+Math.random()*60},90%,${60+Math.random()*20}%)`, size:2+Math.random()*3 });
  }
}
function stepFX(){
  ctx.clearRect(0,0,fx.width,fx.height);
  for(let i=particles.length-1;i>=0;i--){
    const p = particles[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=0.08; p.life--;
    ctx.globalCompositeOperation="lighter"; ctx.fillStyle=p.col; ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();
    if(p.life<=0) particles.splice(i,1);
  }
  requestAnimationFrame(stepFX);
}
new ResizeObserver(resizeFX).observe(stage); resizeFX(); stepFX();

/* ====== ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ«ãƒ¼ãƒ— ====== */
function render(){
  controls.update();
  composer.render(); // ãƒã‚¹ãƒˆãƒ—ãƒ­ã‚»ã‚¹çµŒç”±
}
renderer.setAnimationLoop(render);

/* ====== UIé…ç·š ====== */
document.getElementById("apply").addEventListener("click", ()=>{
  const p = Math.max(1, Math.floor(Number(document.getElementById("people").value)||0));
  spinsLeft = p*2; refreshOrders(); showToast(`äººæ•° ${p}äºº / åˆè¨ˆ ${spinsLeft}å›`);
});
document.getElementById("spin").addEventListener("click", spin);
document.getElementById("undo").addEventListener("click", ()=>{ if(spinning||history.length===0) return; history.pop(); spinsLeft += 1; refreshOrders(); });
document.getElementById("reset").addEventListener("click", ()=>{ if(spinning) return; history=[]; spinsLeft=0; refreshOrders(); });
document.addEventListener("keydown", e=>{ if(e.key.toLowerCase()==="f"){ const de=document.documentElement; if(!document.fullscreenElement){ de.requestFullscreen?.(); } else { document.exitFullscreen?.(); } } });

function buildAll(){ buildWeights(); refreshOrders(); }
function showToast(msg){ toast.textContent=msg; toast.classList.add("show"); setTimeout(()=>toast.classList.remove("show"), 1400); }
buildAll();
</script>
</body>
</html>
