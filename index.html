<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Cheese Wonderland â€” Fullscreen Roulette (Stop + LED outer + Smooth stop)</title>
<style>
  :root{
    --bg:#080b14; --ink:#eef2ff; --panel:#0e1330;
    --gold:#f3c862; --accent:#ff5a76;
  }
  html,body{height:100%;margin:0;background:radial-gradient(1000px 700px at 70% -10%, rgba(255,255,255,.06), transparent 60%), var(--bg); color:var(--ink); font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,"Noto Sans JP"; overflow:hidden}
  #stage{position:fixed;inset:0}

  /* æ®‹ã‚Šå›æ•° */
  #leftBadge{position:fixed;left:10px;top:10px;z-index:20;background:rgba(20,24,40,.7);
    border:1px solid rgba(255,255,255,.1);padding:8px 12px;border-radius:10px;font-weight:800;backdrop-filter: blur(4px)}

  /* ãƒœã‚¿ãƒ³ */
  #controls{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);display:flex;gap:14px;z-index:20}
  button{appearance:none;border:none;border-radius:14px;padding:14px 22px;font-size:18px;font-weight:900;cursor:pointer;
    background:linear-gradient(180deg,#ffe08a,#f7b733);color:#141414;box-shadow:0 10px 28px rgba(0,0,0,.45)}
  button.ghost{background:#1c2342;color:#e9ecff;border:1px solid rgba(255,255,255,.14);box-shadow:none}
  button:disabled{opacity:.5;cursor:not-allowed}
  #mute{width:46px;padding:12px 0}

  /* å½“ãŸã‚Šãƒˆãƒ¼ã‚¹ãƒˆ */
  #toast{position:fixed;left:50%;top:16px;transform:translateX(-50%) translateY(-16px);background:#111533;
    border:1px solid rgba(255,255,255,.18);padding:10px 14px;border-radius:12px;font-weight:800;opacity:0;
    transition:.25s;z-index:30}
  #toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

  /* äººæ•°ãƒ¢ãƒ¼ãƒ€ãƒ« */
  #start{position:fixed;inset:0;display:grid;place-items:center;background:rgba(5,8,16,.92);z-index:40}
  #start .card{background:linear-gradient(180deg,#161c33,#0f1330);border:1px solid rgba(255,255,255,.12);border-radius:16px;
    padding:20px;width:min(92vw,480px);box-shadow:0 24px 60px rgba(0,0,0,.6)}
  #start .row{display:flex;gap:10px;align-items:center}
  #start input[type=number]{flex:1;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.15);
    background:#0c1126;color:#fff;font-size:18px}

  /* é¡”ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
  #faceOverlay{position:fixed;inset:0;display:none;place-items:center;background:radial-gradient(600px 420px at 50% 40%,rgba(255,255,255,.06),transparent 60%);z-index:35;pointer-events:none}
  #faceOverlay img{max-width:62vw;max-height:62vh;border-radius:16px;box-shadow:0 18px 60px rgba(0,0,0,.55);animation:pop .5s ease both}
  @keyframes pop{0%{transform:scale(.86);opacity:0}100%{transform:scale(1);opacity:1}}

  /* ã‚µãƒãƒªãƒ¼ */
  #summary{position:fixed;inset:0;display:none;background:rgba(0,0,0,.92);z-index:50;color:#fff}
  #summary .wrap{max-width:980px;margin:60px auto;padding:0 16px}
  #summary table{width:100%;border-collapse:collapse;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);border-radius:12px;overflow:hidden}
  #summary th,#summary td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08)}
  #summary th{text-align:left;color:#aeb8ff}
  #summary tr:last-child td{border-bottom:none}

  /* LED ãƒªãƒ ï¼ˆDOMï¼‰ */
  #ledRing{position:fixed;inset:0;pointer-events:none;display:grid;place-items:center;z-index:10}
  #ledRing .ring{position:relative; width:min(80vmin,980px); aspect-ratio:1/1;} /* ã»ã‚“ã®å°‘ã—å¤§ãã‚ã« */
  #ledRing .ring .bulb{position:absolute; width:1.8%; aspect-ratio:1/1; border-radius:50%;
    background:radial-gradient(circle at 30% 30%, #fff8, #fff0 45%), radial-gradient(circle, #fbe6a4 0, #caa24a 60%, #7a5b1b 100%);
    box-shadow:0 0 8px rgba(243,200,98,.55); filter:brightness(.9)}
</style>
</head>
<body>
<div id="stage"></div>

<!-- LED Rim -->
<div id="ledRing"><div class="ring" id="ring"></div></div>

<div id="leftBadge">æ®‹ã‚Š <b id="leftNum">--</b> å›</div>

<div id="controls">
  <button id="spin">å›ã™ ğŸ¡</button>
  <button id="stop" class="ghost">æ­¢ã‚ã‚‹ â¹</button>
  <button id="mute" class="ghost" title="ãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡æ›¿">ğŸ”ˆ</button>
  <button id="reset" class="ghost">ãƒªã‚»ãƒƒãƒˆ ğŸ”„</button>
</div>

<div id="toast">å½“ãŸã‚Šï¼</div>

<!-- äººæ•°å…¥åŠ› -->
<div id="start">
  <div class="card">
    <h2 style="margin:0 0 10px">äººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
    <div class="row">
      <input type="number" id="people" min="1" step="1" value="2">
      <button id="startBtn">é–‹å§‹</button>
    </div>
    <div style="opacity:.7;margin-top:10px">â€» 1äºº2å›ãƒ—ãƒ¬ã‚¤</div>
  </div>
</div>

<!-- é¡”ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="faceOverlay"><img id="faceImg" alt=""></div>

<!-- çµæœã‚µãƒãƒªãƒ¼ -->
<div id="summary">
  <div class="wrap">
    <h2>çµæœã¾ã¨ã‚</h2>
    <div id="list"></div>
    <div style="margin-top:14px;display:flex;gap:10px">
      <button id="again">ã‚‚ã†ä¸€åº¦</button>
      <button id="closeSummary" class="ghost">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<!-- three.jsï¼ˆémoduleã§ç¢ºå®Ÿå‹•ä½œï¼‰ -->
<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script>
/* ========== åŸºæœ¬ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========== */
const TAU = Math.PI * 2;
const SECTOR = 60; // 1åŒºç”»60Â°
const deg = d => THREE.MathUtils.degToRad(d);
const radToDeg = r => THREE.MathUtils.radToDeg(r);
const norm = a => THREE.MathUtils.euclideanModulo(a, TAU);
/* æ™‚è¨ˆè§’ï¼ˆ0=12æ™‚ æ™‚è¨ˆå›ã‚Š+ï¼‰â‡” æ•°å­¦è§’ï¼ˆ0=3æ™‚ åæ™‚è¨ˆå›ã‚Š+ï¼‰ */
function toClockDeg(mathDeg){ return (90 - mathDeg + 360) % 360; }
function toMathDeg(clockDeg){ return (90 - clockDeg + 360) % 360; }

/* ========== ãƒ‡ãƒ¼ã‚¿ ========== */
const ITEMS = [
  { name:"ç‰›ã‚³ãƒ­ã‚«ãƒ„",     emoji:"ğŸ¥©", centerClock:  60 },
  { name:"ãˆã³ãƒ•ãƒªãƒƒã‚¿ãƒ¼", emoji:"ğŸ¤", centerClock: 120 },
  { name:"ãƒ­ãƒ¼ã‚¹ãƒˆãƒãƒ¼ã‚¯", emoji:"ğŸ–", centerClock: 180 },
  { name:"ãƒ•ãƒ©ã‚¤ãƒ‰ãƒã‚­ãƒ³", emoji:"ğŸ—", centerClock: 240 },
  { name:"ãƒã‚²ãƒƒãƒˆ",       emoji:"ğŸ¥–", centerClock: 300 },
  { name:"é‡èœç››ã‚Šåˆã‚ã›", emoji:"ğŸ¥¦", centerClock:   0 },
];
const FACES = ["face.png","suprised.png","happy.png","laugh.png","funny.png"];
const FACE_MAP = {
  "ç‰›ã‚³ãƒ­ã‚«ãƒ„":"funny.png",
  "ãˆã³ãƒ•ãƒªãƒƒã‚¿ãƒ¼":"happy.png",
  "ãƒ­ãƒ¼ã‚¹ãƒˆãƒãƒ¼ã‚¯":"laugh.png",
  "ãƒ•ãƒ©ã‚¤ãƒ‰ãƒã‚­ãƒ³":"suprised.png",
  "ãƒã‚²ãƒƒãƒˆ":"face.png",
  "é‡èœç››ã‚Šåˆã‚ã›":"happy.png",
};

/* ========== çŠ¶æ…‹ã¨DOM ========== */
let spinsLeft = 0, spinning = false, pointerAngle = 0; // é‡ æ•°å­¦è§’(rad)
let results = [];
const leftNum = document.getElementById('leftNum');
const toast = document.getElementById('toast');
const faceOverlay = document.getElementById('faceOverlay');
const faceImg = document.getElementById('faceImg');
const setLeft = (n)=> leftNum.textContent = n;
const showToast = (m)=>{ toast.textContent=m; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1100); };

/* ========== LED ãƒªãƒ ç”Ÿæˆï¼ˆåŠå¾„ã‚’å°‘ã—å¤–ã¸ï¼‰ ========== */
/* ç”»é¢ã‚µã‚¤ã‚ºã«å¯¾ã—ã¦ç›¸å¯¾ï¼šä¸­å¿ƒã‹ã‚‰ã®åŠå¾„%ï¼ˆæ—¢å®š 46% â†’ 49.5% ã«æ‹¡å¤§ï¼‰ */
const LED_RADIUS_PCT = 49.5; // å¿…è¦ãªã‚‰ 48ã€œ50 ã«å¾®èª¿æ•´ã™ã‚‹ã¨ â€œ+1cm ç›¸å½“â€ ã‚’è¿½ã„è¾¼ã‚ã¾ã™
const ledBulbs = [];
(function makeLED(){
  const ring = document.getElementById('ring');
  const bulbs = 64;
  for(let i=0;i<bulbs;i++){
    const b = document.createElement('div');
    b.className = 'bulb';
    const aMath = i/bulbs * 360; // æ•°å­¦è§’ï¼ˆ0=å³ï¼‰
    b.style.left = 50 + LED_RADIUS_PCT * Math.cos(deg(aMath)) / 100 * 100 + '%';
    b.style.top  = 50 + LED_RADIUS_PCT * Math.sin(deg(aMath)) / 100 * 100 + '%';
    ring.appendChild(b);
    ledBulbs.push({el:b, aMath});
  }
})();

/* LED åˆ¶å¾¡ï¼ˆé€Ÿåº¦è¿½å¾“ï¼†å‹ã¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç™ºå…‰ï¼‰ */
let ledPhase = 0;          // 0..1
let ledSpeed = 0.5;        // ã‚¢ã‚¤ãƒ‰ãƒ«é€Ÿåº¦ï¼ˆç›¸å¯¾ï¼‰
let ledState = 'idle';     // 'idle' | 'spin' | 'win'

function setLEDIdle(){ ledState='idle'; ledSpeed = 0.6; highlightNone(); }
function setLEDSpin(speed){ ledState='spin'; ledSpeed = 4 * Math.min(1, speed); }
function setLEDWin(centerClock){
  ledState='win';
  highlightSectorClock(centerClock, 30);
  setTimeout(()=>{ setLEDIdle(); }, 1400);
}

function highlightNone(){
  ledBulbs.forEach(({el})=> el.style.boxShadow = "0 0 8px rgba(243,200,98,.55)");
}

function highlightSectorClock(centerClock, half){
  const minC = (centerClock - half + 360) % 360;
  const maxC = (centerClock + half + 360) % 360;
  ledBulbs.forEach(({el, aMath})=>{
    const aClock = (90 - aMath + 360) % 360; // æ•°å­¦è§’â†’æ™‚è¨ˆè§’
    const inArc = (minC<maxC) ? (aClock>=minC && aClock<=maxC)
                              : (aClock>=minC || aClock<=maxC);
    el.style.boxShadow = inArc
      ? "0 0 20px 6px rgba(255,230,160,.95), 0 0 6px rgba(255,230,160,.9)"
      : "0 0 6px rgba(243,200,98,.45)";
    el.style.filter = inArc ? "brightness(1.6)" : "brightness(.9)";
  });
}

function stepLED(dt){
  if(ledState==='idle' || ledState==='spin'){
    ledPhase = (ledPhase + dt*ledSpeed) % 1;
    ledBulbs.forEach(({el, aMath})=>{
      const a = aMath/360;
      const k = Math.max(0, Math.cos((a - ledPhase)*Math.PI*2*4));
      const bright = 0.6 + 0.4*k;
      el.style.filter = `brightness(${bright})`;
      el.style.boxShadow = `0 0 ${8+12*k}px rgba(243,200,98,${.35+.45*k})`;
    });
  }
}

/* ========== Three.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ— ========== */
const stage = document.getElementById('stage');
const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
renderer.setSize(innerWidth, innerHeight);
stage.appendChild(renderer.domElement);

let camera;
const scene = new THREE.Scene();

const loader = new THREE.TextureLoader();
const tex = loader.load('roulette_ui_6_sections.png');
tex.colorSpace = THREE.SRGBColorSpace;
const wheel = new THREE.Mesh(new THREE.PlaneGeometry(1,1), new THREE.MeshBasicMaterial({ map:tex, transparent:true }));
scene.add(wheel);
// ç”»é¢ã‚µã‚¤ã‚ºã«åˆã‚ã›ã¦ã‚«ãƒ¡ãƒ©ãƒ»ç›¤ã‚µã‚¤ã‚ºãƒ»é‡ä½ç½®ã‚’èª¿æ•´
function fit(){
  const w = innerWidth, h = innerHeight;
  renderer.setSize(w, h);

  // ã‚ªãƒ«ã‚½ã‚«ãƒ¡ãƒ©ã‚’æ¯å›ä½œã‚Šç›´ã—ï¼ˆç”»é¢ã„ã£ã±ã„ã«è¡¨ç¤ºï¼‰
  camera = new THREE.OrthographicCamera(-w/2, w/2, h/2, -h/2, -10, 10);
  camera.position.set(0, 0, 5);
  camera.lookAt(0, 0, 0);

  // ç›¤ï¼ˆwheelï¼‰ã‚’æ­£æ–¹ã§ãƒ•ã‚£ãƒƒãƒˆ
  const size = Math.min(w, h) * 0.86;   // ç”»é¢ã‚’ã»ã¼å æœ‰
  wheel.scale.set(size, size, 1);

  // â˜… é‡ã®ã‚¹ã‚±ãƒ¼ãƒ«ãƒ»ä½ç½®ã‚’ç›¤ã‚µã‚¤ã‚ºã‹ã‚‰ç®—å‡º
  positionPointerByWheelSize(size);

  // â˜… å›è»¢ãƒªã‚»ãƒƒãƒˆï¼ˆåˆæœŸå§¿å‹¢ï¼šçœŸä¸Šï¼‰
  pointerGroup.rotation.z = pointerAngle = 0;
}

// åˆæœŸåŒ–ï¼†ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
addEventListener('resize', fit);
functionã€€fit(){
// â”€â”€ é‡ï¼ˆè±ªè¯ç‰ˆï¼‰ï¼šé‡‘ã®ç¸ + ãƒã‚ªãƒ³èŠ¯ + å®çŸ³ + ã‚°ãƒ­ãƒ¼ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const pointerGroup = new THREE.Group(); scene.add(pointerGroup);

// 1) é‡ã‚·ã‚§ã‚¤ãƒ—ï¼ˆå°‘ã—ãã³ã‚Œï¼‹ãƒ†ãƒ¼ãƒ«ä»˜ãã§â€œé€Ÿãã†â€ã«ï¼‰
function arrowShape(){
  const s = 1; const w = 0.16*s, h = 0.22*s, tail = 0.14*s;
  const sh = new THREE.Shape();
  sh.moveTo(0,  h);          // å…ˆç«¯
  sh.lineTo( w, -h*0.4);
  sh.lineTo( w*0.75, -h*0.6);
  sh.lineTo( w*0.45, -h*0.65);
  sh.lineTo( w*0.45, -h - tail);
  sh.lineTo(-w*0.45, -h - tail);
  sh.lineTo(-w*0.45, -h*0.65);
  sh.lineTo(-w*0.75, -h*0.6);
  sh.lineTo(-w, -h*0.4);
  sh.lineTo(0,  h);
  return sh;
}

// 2) é‡‘ã®ç¸ï¼ˆåšã¿å°‘ã— / ã‚¯ãƒªã‚¢ã‚³ãƒ¼ãƒˆã§é‡‘å±æ„Ÿï¼‰
const rimGeo = new THREE.ExtrudeGeometry(arrowShape(), { depth: 0.06, bevelEnabled: true, bevelSize: 0.008, bevelThickness: 0.008, bevelSegments: 3 });
rimGeo.center();
const rimMat = new THREE.MeshPhysicalMaterial({
  color: 0xd4a83d, metalness: 0.95, roughness: 0.25, clearcoat: 1, clearcoatRoughness: 0.2
});
const rim = new THREE.Mesh(rimGeo, rimMat);
rim.rotation.x = Math.PI*0.5;
pointerGroup.add(rim);

// 3) ãƒã‚ªãƒ³èŠ¯ï¼ˆèµ¤ã€œãƒ”ãƒ³ã‚¯ã®å†…å´æ¿ / åŠ ç®—åˆæˆã§å…‰ã‚‹ï¼‰
const coreGeo = new THREE.ShapeGeometry(arrowShape());
coreGeo.center();
const coreMat = new THREE.MeshBasicMaterial({ color: 0xff3b6a, transparent: true, opacity: 0.95, blending: THREE.AdditiveBlending });
const core = new THREE.Mesh(coreGeo, coreMat);
core.rotation.x = Math.PI*0.5;
core.position.y = 0.031;        // ç¸ã®ä¸Šã«å°‘ã—æµ®ã‹ã›ã‚‹
pointerGroup.add(core);

// 4) å…ˆç«¯ã®å®çŸ³ï¼ˆå°ã•ãªçƒï¼‹ã‚¨ãƒŸãƒƒã‚·ãƒ–ï¼‰
const gem = new THREE.Mesh(
  new THREE.SphereGeometry(0.032, 24, 24),
  new THREE.MeshStandardMaterial({ color: 0xffe6a0, emissive: 0xff9fb5, emissiveIntensity: 0.6, metalness: 0.3, roughness: 0.25 })
);
gem.position.set(0, 0.115, 0.018);
pointerGroup.add(gem);

// 5) ã‚°ãƒ­ãƒ¼ï¼ˆã‚¹ãƒ—ãƒ©ã‚¤ãƒˆã§ãµã‚“ã‚ã‚Šç™ºå…‰ï¼‰
function makeGlowSprite(sizePx=220, color='rgba(255,90,118,1)'){
  const cvs = document.createElement('canvas'); cvs.width = cvs.height = sizePx;
  const g = cvs.getContext('2d');
  const grd = g.createRadialGradient(sizePx/2,sizePx/2,0, sizePx/2,sizePx/2,sizePx/2);
  grd.addColorStop(0, color.replace('1)', '0.55)'));
  grd.addColorStop(1, color.replace('1)', '0)'));
  g.fillStyle = grd; g.fillRect(0,0,sizePx,sizePx);
  const tex = new THREE.CanvasTexture(cvs); tex.colorSpace = THREE.SRGBColorSpace;
  return new THREE.Sprite(new THREE.SpriteMaterial({ map: tex, transparent: true, blending: THREE.AdditiveBlending, depthWrite:false }));
}
const glowTip  = makeGlowSprite(320);
glowTip.position.set(0, 0.115, 0.02);
glowTip.scale.set(0.35, 0.35, 1);

const glowBody = makeGlowSprite(640);
glowBody.position.set(0, -0.10, 0.01);
glowBody.scale.set(0.7, 0.7, 1);

pointerGroup.add(glowTip, glowBody);

// 6) é‡ã®ä½ç½®ï¼ˆã‚ãªãŸã®æ—¢å­˜å€¤ã«åˆã‚ã›ã‚‹ï¼‰
function positionPointerByWheelSize(size){
  const ps = size * 0.22;                  // ã‚¹ã‚±ãƒ¼ãƒ«æ„Ÿã¯æ—¢å­˜ã¨åŒã˜å¼ã«æƒãˆã‚‹
  pointerGroup.scale.set(ps, ps, ps);
  pointerGroup.position.set(0, size*0.40, 0); // ç›¤ã®å¤–å‘¨ä»˜è¿‘
}

/* ========== ã‚µã‚¦ãƒ³ãƒ‰ ========== */
let audioCtx, master, loopTimer, muted=false, bgmNode;
function ensureAudio(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  master = audioCtx.createGain(); master.gain.value=.45; master.connect(audioCtx.destination);
  // è»½ã„BGMãƒ«ãƒ¼ãƒ—
  const bpm=112, beat=60/bpm;
  function startBGM(){
    if(muted) return;
    stopBGM();
    bgmNode = setInterval(()=>{
      const t0 = audioCtx.currentTime;
      [0,1,2,3,4,5,6,7].forEach((step)=>{
        const t = t0 + step*beat/2;
        const f = [392,494,587,659][step%4]; // G B D E
        const o = audioCtx.createOscillator(); o.type='sine'; o.frequency.value=f;
        const g = audioCtx.createGain(); g.gain.value=0.0001; o.connect(g).connect(master);
        o.start(t);
        g.gain.setValueAtTime(0.0001,t);
        g.gain.exponentialRampToValueAtTime(0.10,t+0.02);
        g.gain.exponentialRampToValueAtTime(0.0001,t+beat/2-0.02);
        o.stop(t+beat/2);
      });
    }, beat*1000*4);
  }
  function stopBGM(){ if(bgmNode){ clearInterval(bgmNode); bgmNode=null; } }
  ensureAudio.startBGM = startBGM; ensureAudio.stopBGM = stopBGM;
}
function startSpinLoop(){
  if(muted) return; ensureAudio(); stopSpinLoop();
  loopTimer = setInterval(()=>{
    const freqs = [523.25,659.25,783.99];
    freqs.forEach((f,i)=>{
      const t = audioCtx.currentTime + i*0.08;
      const o = audioCtx.createOscillator(); o.type='triangle'; o.frequency.value=f;
      const g = audioCtx.createGain(); g.gain.value=0.0001; o.connect(g).connect(master);
      o.start(t);
      g.gain.setValueAtTime(0.0001,t);
      g.gain.exponentialRampToValueAtTime(0.22,t+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001,t+0.15);
      o.stop(t+0.16);
    });
  }, 260);
}
function stopSpinLoop(){ if(loopTimer){ clearInterval(loopTimer); loopTimer=null; } }
function playHitSFX(){
  if(muted) return; ensureAudio();
  const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
  o.type='square'; o.frequency.setValueAtTime(880, audioCtx.currentTime);
  g.gain.value=0.0001; o.connect(g).connect(master); o.start();
  const t = audioCtx.currentTime;
  g.gain.exponentialRampToValueAtTime(0.35, t+0.01);
  o.frequency.exponentialRampToValueAtTime(1760, t+0.12);
  g.gain.exponentialRampToValueAtTime(0.0001, t+0.28);
  o.stop(t+0.30);
}

/* ========== è§’åº¦â†’ã‚¢ã‚¤ãƒ†ãƒ åˆ¤å®šï¼ˆæ™‚è¨ˆè§’ï¼‰ ========== */
function clockDegFromRad(rad){
  const mathDeg = (radToDeg(rad) % 360 + 360) % 360;
  return (90 - mathDeg + 360) % 360;
}
function itemIdxByClockDeg(d){
  const a = ((d % 360) + 360) % 360;
  if (a >= 30  && a < 90 ) return 0; // ç‰›
  if (a >= 90  && a < 150) return 1; // ãˆã³
  if (a >= 150 && a < 210) return 2; // ãƒ­ãƒ¼ã‚¹ãƒˆ
  if (a >= 210 && a < 270) return 3; // ãƒ•ãƒ©ã‚¤ãƒ‰
  if (a >= 270 && a < 330) return 4; // ãƒã‚²ãƒƒãƒˆ
  return 5;                           // é‡èœï¼ˆ330â€“360 or 0â€“30ï¼‰
}
function idxByAngleRad(rad){ return itemIdxByClockDeg(clockDegFromRad(rad)); }
function targetAngleForIdx(idx){
  const clockCenter = ITEMS[idx].centerClock;
  const mathCenter = toMathDeg(clockCenter);
  return deg(mathCenter);
}
function faceFor(name){ return FACE_MAP[name] || "face.png"; }

/* ========== é‡ã‚¹ãƒ”ãƒ³ï¼ˆå›ã™/æ­¢ã‚ã‚‹ï¼šã‚¹ãƒ ãƒ¼ã‚¹åœæ­¢ç‰ˆï¼‰ ========== */
let omega = 0;              // è§’é€Ÿåº¦ï¼ˆrad/sï¼‰
let spinMode = 'idle';      // 'idle' | 'spin' | 'stoppingTween'
const OMEGA_MAX = 10;       // æœ€é«˜é€Ÿï¼ˆèª¿æ•´å¯ï¼‰
const ACCEL     = 16;       // åŠ é€Ÿåº¦

// åœæ­¢ãƒˆã‚¥ã‚¤ãƒ¼ãƒ³ç”¨
let stopStartAngle = 0;
let stopTargetAngle = 0;
let stopElapsed = 0;
let stopDuration = 2.8;     // ç§’ï¼ˆã‚†ã£ãã‚Šæ­¢ã¾ã‚‹ï¼‰

function startSpin(){
  if(spinning || spinsLeft<=0) return;
  spinning = true;
  document.getElementById('spin').disabled = true;
  document.getElementById('stop').disabled = false;

  ensureAudio(); ensureAudio.startBGM?.();
  startSpinLoop();

  spinMode='spin';
  omega = 0.0001;
  setLEDSpin(0.2);
}

function pressStop(){
  if(spinMode!=='spin') return;
  spinMode='stoppingTween';
  stopSpinLoop();

  // ä»Šã®è§’åº¦ã‹ã‚‰ã€ŒæŒ‡ã—ã¦ã„ã‚‹åŒºç”»ã®ä¸­å¿ƒã€ã¸ã€æ™‚é–“ãƒ™ãƒ¼ã‚¹ã®æ¸›é€Ÿã§ç€åœ°
  const nowA = norm(pointerGroup.rotation.z);
  const idx  = idxByAngleRad(nowA);
  const tgt  = targetAngleForIdx(idx);
  const laps = 4 + Math.floor(Math.random()*3); // 4ã€œ6å‘¨ã§è‡ªç„¶
  stopStartAngle  = nowA;
  stopTargetAngle = nowA + laps*TAU + shortestDelta(nowA, tgt);
  stopElapsed = 0;
  stopDuration = 3.0; // ã•ã‚‰ã«ã‚†ã£ãã‚Šã«ã—ãŸã‘ã‚Œã° 3.2ã€œ3.6 ã«
}

function shortestDelta(from, to){
  let d = norm(to) - norm(from);
  if (d > Math.PI) d -= TAU;
  if (d < -Math.PI) d += TAU;
  return d;
}

function finishStop(){
  pointerGroup.rotation.z = norm(stopTargetAngle);
  pointerAngle = pointerGroup.rotation.z;
  spinMode='idle'; omega=0; setLEDIdle();

  const idx = idxByAngleRad(pointerAngle);
  const it  = ITEMS[idx];
  results.push({ idx, name: it.name, emoji: it.emoji });

  faceImg.src = faceFor(it.name);
  faceOverlay.style.display = 'grid';
  playHitSFX(); showToast(`${it.emoji} ${it.name}ï¼`);
  setLEDWin(ITEMS[idx].centerClock);
  setTimeout(()=>{ faceOverlay.style.display='none'; }, 1700);

  spinsLeft -= 1; setLeft(spinsLeft);
  spinning = false;
  document.getElementById('spin').disabled = (spinsLeft<=0);
  document.getElementById('stop').disabled = true;

  if (spinsLeft<=0) showSummary();
  
// é‡ã®ã‚¹ãƒ—ãƒªãƒ³ã‚°ï¼ˆå°ã•ãæ°—æŒã¡ã‚ˆãæºã‚Œã‚‹ï¼‰
{
  const base = pointerGroup.rotation.z;
  let t = 0;
  (function spring(){
    t += 1/60;
    const amp = THREE.MathUtils.degToRad(2.6) * Math.exp(-2.8*t);
    const off = amp * Math.sin(11 * t);
    pointerGroup.rotation.z = base + off;
    if(amp > THREE.MathUtils.degToRad(0.06)) requestAnimationFrame(spring);
    else pointerGroup.rotation.z = base;
  })();
}
}

/* ========== é€²è¡Œï¼ˆrender ã‹ã‚‰å‘¼ã¶ï¼‰ ========== */
function stepSpin(dt){
  if(spinMode==='idle') return;

  if(spinMode==='spin'){
    omega = Math.min(OMEGA_MAX, omega + ACCEL*dt);
    pointerGroup.rotation.z = norm(pointerGroup.rotation.z + omega*dt);
    setLEDSpin(omega/OMEGA_MAX);
    return;
  }

  if(spinMode==='stoppingTween'){
    // æ™‚é–“ãƒ™ãƒ¼ã‚¹ã®ã‚¹ãƒ ãƒ¼ã‚¹æ¸›é€Ÿï¼ˆã‚¤ãƒ¼ã‚¸ãƒ³ã‚°ã§ã‚†ã£ãã‚Šæ­¢ã¾ã‚‹ï¼‰
    stopElapsed += dt;
    const t = Math.min(1, stopElapsed / stopDuration);
    const ease = 1 - Math.pow(1 - t, 3);  // easeOutCubic
    const total = stopTargetAngle - stopStartAngle; // é€£ç¶šç©ºé–“ã§OKï¼ˆtargetã¯ã™ã§ã«å‘¨å›è¾¼ã¿ï¼‰
    pointerGroup.rotation.z = norm(stopStartAngle + total * ease);

    // LED ã‚‚é€Ÿåº¦æ„Ÿã‚’ã ã‚“ã ã‚“è½ã¨ã™
    setLEDSpin(1 - t * 0.95);

    if (t >= 1){
      finishStop();
    }
  }
}

/* ========== ã‚µãƒãƒªãƒ¼ ========== */
function showSummary(){
  const map = new Map();
  results.forEach(r=> map.set(r.name, (map.get(r.name)||0)+1));
  const rows = [...map.entries()].map(([name,c])=>`<tr><td>${name}</td><td style="text-align:right">${c}</td></tr>`).join('');
  document.getElementById('list').innerHTML =
    `<table><thead><tr><th>ãƒ¡ãƒ‹ãƒ¥ãƒ¼</th><th style="text-align:right">æ•°é‡</th></tr></thead><tbody>${rows||'<tr><td colspan="2">ãªã—</td></tr>'}</tbody></table>`;
  document.getElementById('summary').style.display='block';
}

/* ========== ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ«ãƒ¼ãƒ— ========== */
let last = performance.now();
function render(){
  const now = performance.now();
  const dt  = Math.min(0.05, (now - last)/1000);
  last = now;

  stepSpin(dt);
  stepLED(dt);

  wheel.rotation.z = 0; // ç›¤ã¯å›ºå®šï¼ˆç”»åƒã‚ºãƒ¬é˜²æ­¢ï¼‰
  renderer.render(scene, camera);
  requestAnimationFrame(render);
}
render();

/* ========== UIé…ç·š ========== */
document.getElementById('spin').addEventListener('click', startSpin);
document.getElementById('stop').addEventListener('click', pressStop);
document.getElementById('reset').addEventListener('click', ()=>{
  stopSpinLoop(); ensureAudio?.stopBGM?.();
  results=[]; spinsLeft=0; setLeft('--');
  document.getElementById('summary').style.display='none';
  document.getElementById('spin').disabled=false;
  document.getElementById('stop').disabled=true;
  pointerGroup.rotation.z = pointerAngle = 0;
  spinMode='idle'; setLEDIdle();
  document.getElementById('start').style.display='grid';
});
document.getElementById('mute').addEventListener('click', ()=>{
  muted=!muted; showToast(muted?'ãƒŸãƒ¥ãƒ¼ãƒˆ':'ã‚µã‚¦ãƒ³ãƒ‰ON');
});

/* äººæ•° â†’ æ®‹ã‚Šå›æ•° */
document.getElementById('startBtn').addEventListener('click', ()=>{
  const p = Math.max(1, Math.floor(Number(document.getElementById('people').value)||0));
  spinsLeft = p*2; setLeft(spinsLeft); results=[]; document.getElementById('start').style.display='none';
  ensureAudio(); ensureAudio.startBGM?.();
  showToast(`äººæ•° ${p}äºº / åˆè¨ˆ ${spinsLeft}å›`);
});

/* ã‚µãƒãƒªãƒ¼å¾Œã®æ“ä½œ */
document.getElementById('again').addEventListener('click', ()=>{
  document.getElementById('summary').style.display='none';
  document.getElementById('start').style.display='grid';
});
document.getElementById('closeSummary').addEventListener('click', ()=>{
  document.getElementById('summary').style.display='none';
});
</script>
</body>
</html>
