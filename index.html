<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Cheese Wonderland â€” Fullscreen Roulette</title>
<style>
  html,body { height:100%; margin:0; background:#0b0f1a; overflow:hidden; font-family:ui-sans-serif, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif; color:#fff; }
  #stage { position:fixed; inset:0; }
  /* HUD */
  #hud { position:fixed; left:16px; top:12px; z-index:20; display:flex; gap:12px; align-items:center; }
  #left { font-weight:800; opacity:.9; background:rgba(20,24,40,.6); padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.08); }
  #buttons { position:fixed; bottom:18px; left:50%; transform:translateX(-50%); display:flex; gap:16px; z-index:20; }
  button { padding:14px 22px; font-size:18px; font-weight:900; border:none; border-radius:14px; cursor:pointer; background:linear-gradient(180deg,#ffe08a,#f7b733); color:#141414; box-shadow:0 10px 28px rgba(0,0,0,.4); }
  button.ghost { background:#1c2342; color:#e9ecff; border:1px solid rgba(255,255,255,.14); box-shadow:none; }
  button:disabled { opacity:.5; cursor:not-allowed; }
  /* ãƒˆãƒ¼ã‚¹ãƒˆ */
  #toast { position:fixed; left:50%; top:16px; transform:translateX(-50%) translateY(-16px); background:#111533; border:1px solid rgba(255,255,255,.18); color:#fff; padding:10px 14px; border-radius:12px; font-weight:800; opacity:0; transition:.25s; z-index:30; }
  #toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
  /* é–‹å§‹ãƒ¢ãƒ¼ãƒ€ãƒ« */
  #start { position:fixed; inset:0; display:grid; place-items:center; background:rgba(5,8,16,.9); z-index:40; }
  #start .card { background:linear-gradient(180deg,#161c33,#0f1330); border:1px solid rgba(255,255,255,.1); border-radius:16px; padding:20px; width:min(90vw,480px); box-shadow:0 24px 60px rgba(0,0,0,.6); }
  #start h2 { margin:0 0 10px; font-size:22px; }
  #start .row { display:flex; gap:10px; align-items:center; }
  #start input[type="number"] { flex:1; padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.15); background:#0c1126; color:#fff; font-size:18px; }
  #start .actions { display:flex; gap:10px; margin-top:14px; justify-content:flex-end; }
  /* çµæœ(é¡”)ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
  #faceOverlay { position:fixed; inset:0; display:none; place-items:center; background:radial-gradient(600px 400px at 50% 40%, rgba(255,255,255,.06), transparent 60%); z-index:35; pointer-events:none; }
  #faceOverlay img { max-width:60vw; max-height:60vh; border-radius:16px; box-shadow:0 18px 60px rgba(0,0,0,.55); animation:pop .45s ease both; }
  @keyframes pop { 0%{ transform:scale(.86); opacity:0 } 100%{ transform:scale(1); opacity:1 } }
  /* æœ€çµ‚ã‚µãƒãƒªãƒ¼ */
  #summary { position:fixed; inset:0; display:none; background:rgba(0,0,0,.92); z-index:50; color:#fff; }
  #summary .wrap { max-width:980px; margin:60px auto; padding:0 16px; }
  #summary h2 { margin:0 0 12px; }
  #summary table { width:100%; border-collapse:collapse; background:rgba(255,255,255,.02); border:1px solid rgba(255,255,255,.08); border-radius:12px; overflow:hidden; }
  #summary th, #summary td { padding:10px; border-bottom:1px solid rgba(255,255,255,.08); }
  #summary th { text-align:left; color:#aeb8ff; }
  #summary tr:last-child td { border-bottom:none; }
</style>
</head>
<body>
<div id="stage"></div>

<div id="hud">
  <div id="left">æ®‹ã‚Š <b id="leftNum">--</b> å›</div>
</div>

<div id="buttons">
  <button id="spin">å›ã™ ğŸ¡</button>
  <button id="reset" class="ghost">ãƒªã‚»ãƒƒãƒˆ ğŸ”„</button>
</div>

<div id="toast">å½“ãŸã‚Šï¼</div>

<!-- é–‹å§‹ï¼ˆäººæ•°å…¥åŠ›ï¼‰ -->
<div id="start">
  <div class="card">
    <h2>äººæ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
    <div class="row">
      <input type="number" id="people" min="1" step="1" value="2">
      <button id="startBtn">é–‹å§‹</button>
    </div>
    <div class="actions">
      <span style="opacity:.7">â€» 1äºº2å›ãƒ—ãƒ¬ã‚¤</span>
    </div>
  </div>
</div>

<!-- é¡”ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="faceOverlay"><img id="faceImg" src="" alt=""></div>

<!-- æœ€çµ‚ã‚µãƒãƒªãƒ¼ -->
<div id="summary">
  <div class="wrap">
    <h2>çµæœã¾ã¨ã‚</h2>
    <div id="list"></div>
    <div style="margin-top:14px;display:flex;gap:10px;">
      <button id="again">ã‚‚ã†ä¸€åº¦</button>
      <button id="closeSummary" class="ghost">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script>
/* ========= ãƒ‡ãƒ¼ã‚¿ ========= */
const ITEMS = [
  { name:"ãˆã³ãƒ•ãƒªãƒƒã‚¿ãƒ¼", emoji:"ğŸ¤" },
  { name:"ãƒ­ãƒ¼ã‚¹ãƒˆãƒãƒ¼ã‚¯", emoji:"ğŸ–" },
  { name:"ãƒ•ãƒ©ã‚¤ãƒ‰ãƒã‚­ãƒ³", emoji:"ğŸ—" },
  { name:"ãƒã‚²ãƒƒãƒˆ",       emoji:"ğŸ¥–" },
  { name:"é‡èœç››ã‚Š",       emoji:"ğŸ¥¦" },
  { name:"ç‰›ã‚³ãƒ­ã‚«ãƒ„",     emoji:"ğŸ¥©" },
];
const FACES = ["face.png","suprised.png","happy.png","laugh.png","funny.png"];
const N = ITEMS.length, ARC = 360/N;

/* ========= çŠ¶æ…‹ ========= */
let spinsLeft = 0, spinning = false, currentAngle = 0;
let history = []; // {index, itemName, face}

/* ========= Three.js ========= */
const stage = document.getElementById("stage");
const renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
renderer.setSize(innerWidth, innerHeight);
stage.appendChild(renderer.domElement);

const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(35, innerWidth/innerHeight, .1, 100);
camera.position.set(0, 4, 7);
scene.add(camera);

scene.add(new THREE.AmbientLight(0xffffff, .6));
const spot = new THREE.SpotLight(0xfff2cc, 1.6, 25, Math.PI/5, .5, 1);
spot.position.set(3,6,3); spot.target.position.set(0,0,0); scene.add(spot, spot.target);

const wheelGroup = new THREE.Group(); scene.add(wheelGroup);

const loader = new THREE.TextureLoader();
const wheelTex = loader.load("roulette_ui_6_sections.png");
const disc = new THREE.Mesh(new THREE.CircleGeometry(3.1, 256), new THREE.MeshStandardMaterial({ map:wheelTex, metalness:.1, roughness:.6 }));
disc.rotation.x = -0.35; wheelGroup.add(disc);

const rim = new THREE.Mesh(new THREE.TorusGeometry(3.12, .12, 32, 128), new THREE.MeshStandardMaterial({ color:0xd1a94a, metalness:.85, roughness:.35 }));
rim.rotation.x = -0.35; wheelGroup.add(rim);

/* ========= HUD ========= */
const leftNum = document.getElementById("leftNum");
const toast = document.getElementById("toast");
function setLeft(n){ leftNum.textContent = n; }
function showToast(msg){ toast.textContent = msg; toast.classList.add("show"); setTimeout(()=>toast.classList.remove("show"), 1100); }

/* ========= ã‚ªãƒ¼ãƒ‡ã‚£ã‚ª ========= */
let audioCtx, bgmNode, sfxGain;
function initAudio(){
  if(audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  sfxGain = audioCtx.createGain(); sfxGain.gain.value = 0.35; sfxGain.connect(audioCtx.destination);
  startBGM();
}
function startBGM(){
  // 8bité¢¨ã‚¢ãƒ«ãƒšã‚¸ã‚ªã®ç°¡æ˜“ãƒ«ãƒ¼ãƒ—ï¼ˆç´„2å°ç¯€ï¼‰
  const tempo = 120;
  const secPerBeat = 60/tempo;
  const osc = audioCtx.createOscillator(); const g = audioCtx.createGain();
  osc.type = "square"; g.gain.value = 0.08;
  osc.connect(g); g.connect(audioCtx.destination);
  let t = audioCtx.currentTime + .05;
  const scale = [0,4,7,12,16]; // Cãƒ¡ã‚¸ãƒ£ãƒ¼å’ŒéŸ³ãƒˆãƒ¼ãƒ³
  for(let bar=0; bar<8; bar++){
    for(let i=0;i<8;i++){
      const n = 220 * Math.pow(2, (scale[(i+bar)%scale.length]+(bar%2?12:0))/12);
      const on = t + (bar*8+i)*secPerBeat/2;
      const off= on + 0.16;
      const o = audioCtx.createOscillator(); const eg=audioCtx.createGain();
      o.type="square"; o.frequency.value = n;
      eg.gain.value=0.0001; o.connect(eg); eg.connect(audioCtx.destination);
      o.start(on); eg.gain.exponentialRampToValueAtTime(0.10, on+0.01);
      eg.gain.exponentialRampToValueAtTime(0.0001, off);
      o.stop(off);
    }
  }
  // ãƒ‰ãƒ­ãƒ¼ãƒ³çš„ãƒ™ãƒ¼ã‚¹
  osc.frequency.value = 110;
  osc.start(); g.gain.setValueAtTime(0.04, audioCtx.currentTime);
  bgmNode = osc;
}
function stopBGM(){ bgmNode?.stop?.(); bgmNode = null; }
function sfxPop(){
  if(!audioCtx) return;
  const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
  o.type="triangle"; o.frequency.value = 880; g.gain.value=0.0001;
  o.connect(g); g.connect(audioCtx.destination);
  const now = audioCtx.currentTime;
  o.start(now);
  o.frequency.exponentialRampToValueAtTime(1320, now + 0.05);
  g.gain.exponentialRampToValueAtTime(0.28, now + 0.01);
  g.gain.exponentialRampToValueAtTime(0.0001, now + 0.25);
  o.stop(now + 0.26);
}

/* ========= é¡”è¡¨ç¤º ========= */
const faceOverlay = document.getElementById("faceOverlay");
const faceImg = document.getElementById("faceImg");
function showFace(){
  const pick = FACES[Math.floor(Math.random()*FACES.length)];
  faceImg.src = pick;
  faceOverlay.style.display = "grid";
  sfxPop();
  setTimeout(()=>{ faceOverlay.style.display="none"; }, 800);
  return pick;
}

/* ========= ãƒ«ãƒ¼ãƒ¬ãƒƒãƒˆå›è»¢ ========= */
function pickIndex(){ return Math.floor(Math.random()*N); }

function spin(){
  if(spinning || spinsLeft<=0) return;
  initAudio(); // æœ€åˆã®æ“ä½œã§ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªåˆæœŸåŒ–

  spinning = true; document.getElementById("spin").disabled = true;

  const idx = pickIndex();
  const center = idx*ARC + ARC/2;
  const jitter = (Math.random()*ARC*0.2) - (ARC*0.1);
  const deltaDeg = -(6*360 + (center - 90) + jitter);
  const start = currentAngle;
  const end = currentAngle + THREE.MathUtils.degToRad(deltaDeg);
  const dur = 5200;
  const t0 = performance.now();

  function easeOutCubic(t){ return 1 - Math.pow(1-t, 3); }
  function anim(now){
    const t = Math.min(1, (now - t0)/dur);
    const k = easeOutCubic(t);
    const ang = start + (end - start)*k;
    wheelGroup.rotation.z = ang;
    if(t<1){ requestAnimationFrame(anim); }
    else{
      currentAngle = end;
      const item = ITEMS[idx];
      showToast(`å½“ãŸã‚Šï¼š${item.emoji} ${item.name}`);
      const face = showFace();
      history.push({ index: idx, itemName: item.name, emoji: item.emoji, face });
      spinsLeft -= 1; setLeft(spinsLeft);
      spinning = false; document.getElementById("spin").disabled = spinsLeft<=0;
      if(spinsLeft<=0){ setTimeout(showSummary, 600); }
    }
    renderer.render(scene, camera);
  }
  requestAnimationFrame(anim);
}

/* ========= ã‚µãƒãƒªãƒ¼ ========= */
const summary = document.getElementById("summary");
const list = document.getElementById("list");
function showSummary(){
  // é›†è¨ˆ
  const counts = new Map();
  history.forEach(h=>counts.set(h.itemName,(counts.get(h.itemName)||0)+1));
  // HTML
  let html = "";
  html += "<h3>å½“ãŸã‚Šã®é †ç•ª</h3>";
  html += '<table><thead><tr><th>#</th><th>ãƒ¡ãƒ‹ãƒ¥ãƒ¼</th></tr></thead><tbody>';
  history.forEach((h,i)=>{ html += `<tr><td>${i+1}</td><td>${h.emoji} ${h.itemName}</td></tr>`; });
  html += "</tbody></table>";
  html += "<h3 style='margin-top:16px;'>é›†è¨ˆ</h3>";
  html += '<table><thead><tr><th>ãƒ¡ãƒ‹ãƒ¥ãƒ¼</th><th>æ•°é‡</th></tr></thead><tbody>';
  ITEMS.forEach(s=>{
    html += `<tr><td>${s.emoji} ${s.name}</td><td>${counts.get(s.name)||0}</td></tr>`;
  });
  html += "</tbody></table>";
  list.innerHTML = html;
  summary.style.display = "block";
}
document.getElementById("closeSummary").onclick = ()=> summary.style.display = "none";
document.getElementById("again").onclick = ()=>{ summary.style.display="none"; hardReset(); };

/* ========= ãƒªã‚»ãƒƒãƒˆ ========= */
function hardReset(){
  history = []; currentAngle = 0; wheelGroup.rotation.z = 0;
  document.getElementById("spin").disabled = true;
  setLeft("--");
  document.getElementById("start").style.display = "grid";
}
document.getElementById("reset").onclick = hardReset;

/* ========= é–‹å§‹ï¼ˆäººæ•°å…¥åŠ›ï¼‰ ========= */
document.getElementById("startBtn").onclick = ()=>{
  const p = Math.max(1, Math.floor(Number(document.getElementById("people").value)||0));
  spinsLeft = p * 2; setLeft(spinsLeft);
  document.getElementById("spin").disabled = false;
  document.getElementById("start").style.display = "none";
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå…¥ã£ãŸã®ã§BGMåˆæœŸåŒ–ï¼†é–‹å§‹ï¼ˆå¿…è¦ãªã‚‰ï¼‰
  initAudio();
};

/* ========= ãƒ«ãƒ¼ãƒ— & ãƒªã‚µã‚¤ã‚º ========= */
document.getElementById("spin").onclick = spin;
addEventListener("resize", ()=>{
  renderer.setSize(innerWidth, innerHeight);
  camera.aspect = innerWidth/innerHeight; camera.updateProjectionMatrix();
});
renderer.setAnimationLoop(()=>{ renderer.render(scene, camera); });
</script>
</body>
</html>
