<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Cheese Wonderland ‚Äî Stop-to-Decelerate Roulette</title>
<style>
  :root{ --bg:#080b14; --ink:#eef2ff; --panel:#0e1330; --accent:#ff5a76 }
  html,body{height:100%;margin:0;background:radial-gradient(1000px 700px at 70% -10%, rgba(255,255,255,.06), transparent 60%), var(--bg); color:var(--ink); font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,"Noto Sans JP"; overflow:hidden}
  #stage{position:fixed;inset:0}

  /* HUD */
  #leftBadge{position:fixed;left:10px;top:10px;z-index:20;background:rgba(20,24,40,.72);
    border:1px solid rgba(255,255,255,.12);padding:8px 12px;border-radius:10px;font-weight:800;backdrop-filter:blur(6px)}
  #toast{position:fixed;left:50%;top:16px;transform:translateX(-50%) translateY(-16px);background:#111533;
    border:1px solid rgba(255,255,255,.18);padding:10px 14px;border-radius:12px;font-weight:800;opacity:0;transition:.25s;z-index:30}
  #toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

  /* Controls */
  #controls{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);display:flex;gap:12px;z-index:20}
  button{appearance:none;border:none;border-radius:14px;padding:14px 20px;font-size:18px;font-weight:900;cursor:pointer}
  .cta{background:linear-gradient(180deg,#ffe08a,#f7b733);color:#151515;box-shadow:0 10px 28px rgba(0,0,0,.4)}
  .ghost{background:#1c2342;color:#e9ecff;border:1px solid rgba(255,255,255,.16)}
  button:disabled{opacity:.55;cursor:not-allowed}

  /* Start modal */
  #start{position:fixed;inset:0;display:grid;place-items:center;background:rgba(5,8,16,.92);z-index:40}
  #start .card{background:linear-gradient(180deg,#161c33,#0f1330);border:1px solid rgba(255,255,255,.12);border-radius:16px;
    padding:20px;width:min(92vw,420px);box-shadow:0 24px 60px rgba(0,0,0,.6)}
  #start .row{display:flex;gap:10px;align-items:center}
  #start input[type=number]{flex:1;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.15);
    background:#0c1126;color:#fff;font-size:18px}

  /* Face overlay */
  #faceOverlay{position:fixed;inset:0;display:none;place-items:center;background:radial-gradient(600px 420px at 50% 40%,rgba(255,255,255,.06),transparent 60%);z-index:35;pointer-events:none}
  #faceOverlay img{max-width:62vw;max-height:62vh;border-radius:16px;box-shadow:0 18px 60px rgba(0,0,0,.55);animation:pop .5s ease both}
  @keyframes pop{0%{transform:scale(.86);opacity:0}100%{transform:scale(1);opacity:1}}

  /* Summary */
  #summary{position:fixed;inset:0;display:none;background:rgba(0,0,0,.92);z-index:50;color:#fff}
  #summary .wrap{max-width:980px;margin:60px auto;padding:0 16px}
  #summary table{width:100%;border-collapse:collapse;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);border-radius:12px;overflow:hidden}
  #summary th,#summary td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08)}
  #summary th{text-align:left;color:#aeb8ff}
  #summary tr:last-child td{border-bottom:none}
</style>
</head>
<body>
<div id="stage"></div>

<div id="leftBadge">ÊÆã„Çä <b id="leftNum">--</b> Âõû</div>

<div id="controls">
  <button id="spin" class="cta">Âõû„Åô üé°</button>
  <button id="stop" class="ghost" disabled>„Çπ„Éà„ÉÉ„Éó ‚úã</button>
  <button id="reset" class="ghost">„É™„Çª„ÉÉ„Éà üîÑ</button>
</div>

<div id="toast">ÂΩì„Åü„ÇäÔºÅ</div>

<!-- Start -->
<div id="start">
  <div class="card">
    <h2 style="margin:0 0 10px">‰∫∫Êï∞„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h2>
    <div class="row">
      <input type="number" id="people" min="1" step="1" value="2">
      <button id="startBtn" class="cta">ÈñãÂßã</button>
    </div>
    <div style="opacity:.7;margin-top:10px">‚Äª 1‰∫∫2Âõû„Éó„É¨„Ç§</div>
  </div>
</div>

<!-- Face -->
<div id="faceOverlay"><img id="faceImg" alt=""></div>

<!-- Summary -->
<div id="summary">
  <div class="wrap">
    <h2>ÁµêÊûú„Åæ„Å®„ÇÅ</h2>
    <div id="list"></div>
    <div style="margin-top:14px;display:flex;gap:10px">
      <button id="again" class="cta">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
      <button id="closeSummary" class="ghost">Èñâ„Åò„Çã</button>
    </div>
  </div>
</div>

<!-- three.js -->
<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script>
/* ===== Âü∫Êú¨Ë®≠ÂÆö ===== */
const FACE_SHOW_MS = 1700;
const TAU = Math.PI*2;
const deg = d => THREE.MathUtils.degToRad(d);
const rad = r => THREE.MathUtils.radToDeg(r);
const norm = a => THREE.MathUtils.euclideanModulo(a, TAU);
const shortestDelta = (from, to)=>{ let d = norm(to)-norm(from); if(d>Math.PI) d-=TAU; if(d<-Math.PI) d+=TAU; return d; };

/* ===== „Çª„ÇØ„Çø„ÉºÂÆöÁæ©Ôºà„ÅîÊåáÂÆö„Å©„Åä„ÇäÔºâ =====
  30‚Äì90: Áâõ„Ç≥„É≠„Ç´„ÉÑ (center 60)
  90‚Äì150: „Åà„Å≥„Éï„É™„ÉÉ„Çø„Éº (120)
  150‚Äì210: „É≠„Éº„Çπ„Éà„Éù„Éº„ÇØ (180)
  210‚Äì270: „Éï„É©„Ç§„Éâ„ÉÅ„Ç≠„É≥ (240)
  270‚Äì330: „Éê„Ç≤„ÉÉ„Éà (300)
  330‚Äì30: ÈáéËèúÁõõ„ÇäÂêà„Çè„Åõ (0)
  Èáù„ÅÆ0rad„ÅØ„ÄåÁúü‰∏ä=90¬∞„Äç„Å™„ÅÆ„Åß„ÄÅpointerAngle(„É©„Ç∏„Ç¢„É≥)‚ÜíÁîªÈù¢„ÅÆËßíÂ∫¶„ÅØ (90¬∞+pointerAngle)„ÄÇ
*/
const ITEMS = [
  { name:"Áâõ„Ç≥„É≠„Ç´„ÉÑ",     emoji:"ü•©", centerDeg:  60, range:[30,90] },
  { name:"„Åà„Å≥„Éï„É™„ÉÉ„Çø„Éº", emoji:"üç§", centerDeg: 120, range:[90,150] },
  { name:"„É≠„Éº„Çπ„Éà„Éù„Éº„ÇØ", emoji:"üçñ", centerDeg: 180, range:[150,210] },
  { name:"„Éï„É©„Ç§„Éâ„ÉÅ„Ç≠„É≥", emoji:"üçó", centerDeg: 240, range:[210,270] },
  { name:"„Éê„Ç≤„ÉÉ„Éà",       emoji:"ü•ñ", centerDeg: 300, range:[270,330] },
  { name:"ÈáéËèúÁõõ„ÇäÂêà„Çè„Åõ", emoji:"ü•¶", centerDeg:   0, range:[330,30] }, // wrap
];
const FACES = ["face.png","suprised.png","happy.png","laugh.png","funny.png"];
const FACE_MAP = {
  "Áâõ„Ç≥„É≠„Ç´„ÉÑ":"funny.png",
  "„Åà„Å≥„Éï„É™„ÉÉ„Çø„Éº":"happy.png",
  "„É≠„Éº„Çπ„Éà„Éù„Éº„ÇØ":"laugh.png",
  "„Éï„É©„Ç§„Éâ„ÉÅ„Ç≠„É≥":"suprised.png",
  "„Éê„Ç≤„ÉÉ„Éà":"face.png",
  "ÈáéËèúÁõõ„ÇäÂêà„Çè„Åõ":"happy.png",
};
const SECTOR = 60;

/* ===== Áä∂ÊÖã„Å®DOM ===== */
let spinsLeft=0, results=[], spinning=false, deceling=false;
let pointerAngle=0;      // Èáù„ÅÆÁèæÂú®Ëßí (rad)
let spinSpeed=0;         // Á≠âÈÄüÂõûËª¢„ÅÆËßíÈÄüÂ∫¶ (rad/s)
let lockedIdx=null;      // STOPÊäº‰∏ã„ÅßÁ¢∫ÂÆö„Åó„Åü„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ

const leftNum = document.getElementById('leftNum');
const setLeft = n => leftNum.textContent = n;
const toast = document.getElementById('toast');
const showToast = m => { toast.textContent=m; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1100); };
const faceOverlay = document.getElementById('faceOverlay');
const faceImg = document.getElementById('faceImg');

const btnSpin = document.getElementById('spin');
const btnStop = document.getElementById('stop');
const btnReset = document.getElementById('reset');

/* ===== Three.js ===== */
const stage = document.getElementById('stage');
const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
renderer.setSize(innerWidth, innerHeight);
stage.appendChild(renderer.domElement);

let camera; const scene = new THREE.Scene();

const loader = new THREE.TextureLoader();
const tex = loader.load('roulette_ui_6_sections.png'); // Áõ§PNG
tex.colorSpace = THREE.SRGBColorSpace;

const wheel = new THREE.Mesh(new THREE.PlaneGeometry(1,1), new THREE.MeshBasicMaterial({ map:tex, transparent:true }));
scene.add(wheel);

// ÈáùÔºà‰∏äÂêë„Åç‰∏âËßíÔºâ
const pointerGroup = new THREE.Group(); scene.add(pointerGroup);
const shp = new THREE.Shape(); shp.moveTo(0,0.18); shp.lineTo(-0.12,-0.18); shp.lineTo(0.12,-0.18); shp.lineTo(0,0.18);
const pointer = new THREE.Mesh(new THREE.ShapeGeometry(shp), new THREE.MeshBasicMaterial({ color:0xff5a76 }));
pointerGroup.add(pointer);

function fit(){
  const w=innerWidth, h=innerHeight;
  renderer.setSize(w,h);
  camera = new THREE.OrthographicCamera(-w/2,w/2,h/2,-h/2,-10,10);
  camera.position.set(0,0,5); camera.lookAt(0,0,0);
  const size = Math.min(w,h)*0.86;
  wheel.scale.set(size,size,1);
  const ps=size*0.22;
  pointer.scale.set(ps,ps,1);
  pointer.position.set(0,size*0.40,0);
  pointerGroup.rotation.z = pointerAngle = 0;
}
addEventListener('resize', fit); fit();

/* ===== ËßíÂ∫¶‚Üí„Ç¢„Ç§„ÉÜ„É†Âà§ÂÆö ===== */
function getItemByAngleDeg(aDeg){
  const a = (aDeg%360+360)%360;
  if(a>=30 && a<90)   return 0;     // Áâõ„Ç≥„É≠„Ç´„ÉÑ
  if(a>=90 && a<150)  return 1;     // „Åà„Å≥„Éï„É™„ÉÉ„Çø„Éº
  if(a>=150 && a<210) return 2;     // „É≠„Éº„Çπ„Éà„Éù„Éº„ÇØ
  if(a>=210 && a<270) return 3;     // „Éï„É©„Ç§„Éâ„ÉÅ„Ç≠„É≥
  if(a>=270 && a<330) return 4;     // „Éê„Ç≤„ÉÉ„Éà
  return 5;                         // ÈáéËèúÁõõ„ÇäÂêà„Çè„ÅõÔºà330‚Äì360 or 0‚Äì30Ôºâ
}
// Èáù„ÅÆËßíÔºàradÔºâ‚ÜíÁîªÈù¢ËßíÂ∫¶ÔºàdegÔºâ„ÄÇ0rad=‰∏ä=90¬∞
const screenDegFromPointer = angRad => (90 + rad(norm(angRad)))%360;
// „Çª„ÇØ„Çø„Éº‰∏≠ÂøÉ„Å∏Ê≠¢„ÇÅ„Çã„Åü„ÇÅ„ÅÆÁõÆÊ®ôËßíÔºàradÔºâ
const targetAngleForIndex = idx => deg(ITEMS[idx].centerDeg - 90);

/* ===== „É¨„É≥„ÉÄ„É™„É≥„Ç∞„É´„Éº„Éó ===== */
let last = performance.now();
function render(now=performance.now()){
  const dt = Math.min(0.033, (now - last)/1000); last = now;

  // Á≠âÈÄüÂõûËª¢‰∏≠ÔºàSTOPÂâçÔºâ
  if(spinning && !deceling){
    pointerAngle = norm(pointerAngle + spinSpeed * dt);
    pointerGroup.rotation.z = pointerAngle;
  }

  wheel.rotation.z = 0; // Áõ§„ÅØÂõ∫ÂÆö
  renderer.render(scene, camera);
  requestAnimationFrame(render);
}
render();

/* ===== „Çµ„Ç¶„É≥„ÉâÔºàÁ∞°ÊòìSEÔºâ ===== */
let audioCtx, master, loopTimer, muted=false;
function ensureAudio(){ if(audioCtx) return; audioCtx = new (window.AudioContext||window.webkitAudioContext)(); master = audioCtx.createGain(); master.gain.value=.45; master.connect(audioCtx.destination); }
function startSpinLoop(){
  if(muted) return; ensureAudio(); stopSpinLoop();
  loopTimer = setInterval(()=>{
    const t = audioCtx.currentTime;
    [523.25,659.25,783.99].forEach((f,i)=>{
      const o=audioCtx.createOscillator(); o.type='triangle'; o.frequency.value=f;
      const g=audioCtx.createGain(); g.gain.value=0.0001; o.connect(g).connect(master);
      const tt = t + i*0.08;
      o.start(tt); g.gain.setValueAtTime(0.0001,tt);
      g.gain.exponentialRampToValueAtTime(0.20, tt+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, tt+0.15);
      o.stop(tt+0.16);
    });
  }, 240);
}
function stopSpinLoop(){ if(loopTimer){ clearInterval(loopTimer); loopTimer=null; } }
function playHitSFX(){
  if(muted) return; ensureAudio();
  const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
  o.type='square'; o.frequency.value=880; o.connect(g).connect(master);
  const t=audioCtx.currentTime; g.gain.value=0.0001; o.start(t);
  g.gain.exponentialRampToValueAtTime(0.35, t+0.01);
  o.frequency.exponentialRampToValueAtTime(1760, t+0.12);
  g.gain.exponentialRampToValueAtTime(0.0001, t+0.28);
  o.stop(t+0.30);
}

/* ===== „Çπ„Éî„É≥/„Çπ„Éà„ÉÉ„Éó ===== */
function spinStart(){
  if(spinning || spinsLeft<=0) return;
  spinning = true; deceling = false; lockedIdx = null;
  btnSpin.disabled = true; btnStop.disabled = false;
  ensureAudio(); startSpinLoop();

  // Á≠âÈÄü„ÅÆËßíÈÄüÂ∫¶Ôºàrad/sÔºâ„ÄÇÈï∑Êäº„Åó„Ç≤„Éº„Ç∏„ÅåÁÑ°„ÅÑ„ÅÆ„ÅßÂõ∫ÂÆöÂÄ§„Åß„ÇÇOK
  spinSpeed = TAU * 1.8; // 1.8Âë®/Áßí„Åè„Çâ„ÅÑÔºà‰ΩìÊÑüËâØ„ÅÑÈÄüÂ∫¶Ôºâ
}
function spinStop(){
  if(!spinning || deceling) return;
  deceling = true; btnStop.disabled = true; stopSpinLoop();

  // STOPÊäº‰∏ãÊôÇ„ÅÆËßíÂ∫¶„Åß„ÄåÂΩì„Åü„Çä„Çª„ÇØ„Çø„Éº„Äç„Çí„É≠„ÉÉ„ÇØ
  const aDeg = screenDegFromPointer(pointerAngle);
  lockedIdx = getItemByAngleDeg(aDeg);

  // „Åù„ÅÆ„Çª„ÇØ„Çø„Éº„ÅÆ‰∏≠ÂøÉËßí„Å∏‚ÄúÂê∏ÁùÄ‚Äù„Åó„Å™„Åå„Çâ3Âë®Âõû„Åó„Å¶Ê≠¢„ÇÅ„Çã
  const jitter = deg((Math.random()*SECTOR*0.16) - (SECTOR*0.08)); // ¬±8%„ÅÆÂ∞è„Éñ„É¨
  const start = norm(pointerAngle);
  const target = norm(targetAngleForIndex(lockedIdx) + jitter);
  const end = start + 3*TAU + shortestDelta(start, target); // 3Âë®ÔºãÊúÄÁü≠Â∑Æ
  const dur = 2800; const t0 = performance.now();
  const ease = t => 1 - Math.pow(1-t, 3);

  (function decel(now){
    const t = Math.min(1, (now - t0)/dur);
    pointerGroup.rotation.z = start + (end - start) * ease(t);
    if(t<1) return requestAnimationFrame(decel);

    pointerAngle = norm(end);
    finishResult();
  })(performance.now());
}
function finishResult(){
  spinning = false; deceling = false; btnSpin.disabled = (spinsLeft<=0); btnStop.disabled = true;

  const it = ITEMS[lockedIdx];
  results.push({ idx: lockedIdx, name: it.name, emoji: it.emoji });

  faceImg.src = FACE_MAP[it.name] || "face.png";
  faceOverlay.style.display = 'grid';
  playHitSFX();
  showToast(`${it.emoji} ${it.name}ÔºÅ`);
  setTimeout(()=>{ faceOverlay.style.display='none'; }, FACE_SHOW_MS);

  spinsLeft -= 1; setLeft(spinsLeft);
  if(spinsLeft<=0) showSummary();
}

/* ===== „Çµ„Éû„É™„Éº ===== */
function showSummary(){
  const map=new Map(); results.forEach(r=> map.set(r.name,(map.get(r.name)||0)+1));
  const rows=[...map.entries()].map(([n,c])=>`<tr><td>${n}</td><td style="text-align:right">${c}</td></tr>`).join('');
  document.getElementById('list').innerHTML =
    `<table><thead><tr><th>„É°„Éã„É•„Éº</th><th style="text-align:right">Êï∞Èáè</th></tr></thead><tbody>${rows||'<tr><td colspan="2">„Å™„Åó</td></tr>'}</tbody></table>`;
  document.getElementById('summary').style.display='block';
}

/* ===== UIÈÖçÁ∑ö ===== */
btnSpin.addEventListener('click', spinStart);
btnStop.addEventListener('click', spinStop);
btnReset.addEventListener('click', ()=>{
  stopSpinLoop(); results=[]; spinsLeft=0; setLeft('--');
  pointerGroup.rotation.z = pointerAngle = 0;
  btnSpin.disabled=false; btnStop.disabled=true;
  document.getElementById('summary').style.display='none';
  document.getElementById('start').style.display='grid';
});

document.getElementById('startBtn').addEventListener('click', ()=>{
  const p = Math.max(1, Math.floor(Number(document.getElementById('people').value)||0));
  spinsLeft = p*2; setLeft(spinsLeft); results=[];
  document.getElementById('start').style.display='none';
  showToast(`‰∫∫Êï∞ ${p}‰∫∫ / ÂêàË®à ${spinsLeft}Âõû`);
});

document.getElementById('again').addEventListener('click', ()=>{
  document.getElementById('summary').style.display='none';
  document.getElementById('start').style.display='grid';
});
document.getElementById('closeSummary').addEventListener('click', ()=>{
  document.getElementById('summary').style.display='none';
});
</script>
</body>
</html>
