<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Cheese Wonderland â€” Fullscreen Roulette (Pro)</title>
<style>
  :root{
    --bg:#080b14; --ink:#eef2ff; --panel:#0e1330;
    --gold:#f3c862; --accent:#ff5a76;
  }
  html,body {
  height:100%;
  margin:0;
  background: 
    linear-gradient(rgba(0,0,0,0.55), rgba(0,0,0,0.55)),
    url("top.png") no-repeat center center fixed;
  background-size: cover;
  color:var(--ink);
  font-family: ui-sans-serif,-apple-system,Segoe UI,Roboto,"Noto Sans JP";
  overflow:hidden;
}#stage{position:fixed;inset:0}

  /* æ®‹ã‚Šå›æ•° */
  #leftBadge{position:fixed;left:10px;top:10px;z-index:20;background:rgba(20,24,40,.7);
    border:1px solid rgba(255,255,255,.1);padding:8px 12px;border-radius:10px;font-weight:800;backdrop-filter: blur(4px)}

  /* ãƒœã‚¿ãƒ³ */
  #controls{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);display:flex;gap:14px;z-index:20}
  button{appearance:none;border:none;border-radius:14px;padding:14px 22px;font-size:18px;font-weight:900;cursor:pointer;
    background:linear-gradient(180deg,#ffe08a,#f7b733);color:#141414;box-shadow:0 10px 28px rgba(0,0,0,.45)}
  button.ghost{background:#1c2342;color:#e9ecff;border:1px solid rgba(255,255,255,.14);box-shadow:none}
  button:disabled{opacity:.5;cursor:not-allowed}
  #mute{width:46px;padding:12px 0}

  /* å½“ãŸã‚Šãƒˆãƒ¼ã‚¹ãƒˆ */
  #toast{position:fixed;left:50%;top:16px;transform:translateX(-50%) translateY(-16px);background:#111533;
    border:1px solid rgba(255,255,255,.18);padding:10px 14px;border-radius:12px;font-weight:800;opacity:0;
    transition:.25s;z-index:30}
  #toast.show{opacity:1;transform:translateX(-50%) translateY(0)}

  /* äººæ•°ãƒ¢ãƒ¼ãƒ€ãƒ« */
  #start{position:fixed;inset:0;display:grid;place-items:center;background:rgba(5,8,16,.92);z-index:40}
  #start .card{background:linear-gradient(180deg,#161c33,#0f1330);border:1px solid rgba(255,255,255,.12);border-radius:16px;
    padding:20px;width:min(92vw,480px);box-shadow:0 24px 60px rgba(0,0,0,.6)}
  #start .row{display:flex;gap:10px;align-items:center}
  #start input[type=number]{flex:1;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.15);
    background:#0c1126;color:#fff;font-size:18px}

  /* é¡”ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
  #faceOverlay{position:fixed;inset:0;display:none;place-items:center;background:radial-gradient(600px 420px at 50% 40%,rgba(255,255,255,.06),transparent 60%);z-index:35;pointer-events:none}
  #faceOverlay img{max-width:62vw;max-height:62vh;border-radius:16px;box-shadow:0 18px 60px rgba(0,0,0,.55);animation:pop .5s ease both}
  @keyframes pop{0%{transform:scale(.86);opacity:0}100%{transform:scale(1);opacity:1}}

  /* ã‚µãƒãƒªãƒ¼ */
  #summary{position:fixed;inset:0;display:none;background:rgba(0,0,0,.92);z-index:50;color:#fff}
  #summary .wrap{max-width:980px;margin:60px auto;padding:0 16px}
  #summary table{width:100%;border-collapse:collapse;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);border-radius:12px;overflow:hidden}
  #summary th,#summary td{padding:10px;border-bottom:1px solid rgba(255,255,255,.08)}
  #summary th{text-align:left;color:#aeb8ff}
  #summary tr:last-child td{border-bottom:none}

  /* LED ãƒªãƒ ï¼ˆDOMï¼‰ */
  #ledRing{position:fixed;inset:0;pointer-events:none;display:grid;place-items:center;z-index:10}
  #ledRing .ring{position:relative; width:min(80vmin,980px); aspect-ratio:1/1;}
  #ledRing .ring .bulb{position:absolute; width:1.8%; aspect-ratio:1/1; border-radius:50%;
    background:radial-gradient(circle at 30% 30%, #fff8, #fff0 45%), radial-gradient(circle, #fbe6a4 0, #caa24a 60%, #7a5b1b 100%);
    box-shadow:0 0 8px rgba(243,200,98,.55); filter:brightness(.9)}

  #start .grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr); /* 3åˆ— */
  gap: 16px;
}

#start .numBtn {
  font-size: 24px;
  font-weight: 800;
  padding: 20px 0;
  border-radius: 14px;
  border: none;
  cursor: pointer;
  background: linear-gradient(180deg, #ffe08a, #f7b733);
  color: #141414;
  box-shadow: 0 10px 28px rgba(0,0,0,.45);
  transition: transform .12s, box-shadow .12s;
}

#start .numBtn:hover {
  transform: scale(1.08);
  box-shadow: 0 12px 32px rgba(0,0,0,.55);
}
</style>
</head>
<body>
<div id="stage"></div>

<!-- LED Rim -->
<div id="ledRing"><div class="ring" id="ring"></div></div>

<div id="leftBadge">æ®‹ã‚Š <b id="leftNum">--</b> å›</div>

<div id="controls">
  <button id="spin">å›ã™ ğŸ¡</button>
  <button id="stop" class="ghost" disabled>æ­¢ã‚ã‚‹ â¹</button>
  <button id="mute" class="ghost" title="ãƒŸãƒ¥ãƒ¼ãƒˆåˆ‡æ›¿">ğŸ”ˆ</button>
  <button id="reset" class="ghost">ãƒªã‚»ãƒƒãƒˆ ğŸ”„</button>
</div>

<div id="toast">å½“ãŸã‚Šï¼</div>

<!-- äººæ•°é¸æŠ -->
<div id="start">
  <div class="card">
    <h2 style="margin:0 0 14px;text-align:center">äººæ•°ã‚’é¸ã‚“ã§ãã ã•ã„</h2>
    <div class="grid">
      <button class="numBtn" data-p="1">1</button>
      <button class="numBtn" data-p="2">2</button>
      <button class="numBtn" data-p="3">3</button>
      <button class="numBtn" data-p="4">4</button>
      <button class="numBtn" data-p="5">5</button>
      <button class="numBtn" data-p="6">6</button>
    </div>
    <div style="opacity:.7;margin-top:14px;text-align:center">â€» 1äºº2å›ãƒ—ãƒ¬ã‚¤</div>
  </div>
</div>

<!-- é¡”ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
<div id="faceOverlay"><img id="faceImg" alt=""></div>

<!-- çµæœã‚µãƒãƒªãƒ¼ -->
<div id="summary">
  <div class="wrap">
    <h2>çµæœã¾ã¨ã‚</h2>
    <div id="list"></div>
    <div style="margin-top:14px;display:flex;gap:10px">
      <button id="again">ã‚‚ã†ä¸€åº¦</button>
      <button id="closeSummary" class="ghost">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<!-- three.jsï¼ˆémoduleã§ç¢ºå®Ÿå‹•ä½œï¼‰ -->
<script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
<script>
/* ========= ä¾¿åˆ©é–¢æ•° ========= */
const TAU = Math.PI * 2;
const deg = d => THREE.MathUtils.degToRad(d);
const radToDeg = r => THREE.MathUtils.radToDeg(r);
const norm = a => THREE.MathUtils.euclideanModulo(a, TAU);
/* æ™‚è¨ˆè§’â‡”æ•°å­¦è§’ */
const toClockDeg = mathDeg => (90 - mathDeg + 360) % 360;
const toMathDeg  = clockDeg => (90 - clockDeg + 360) % 360;

/* ========= ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆè§’åº¦ãƒãƒƒãƒ”ãƒ³ã‚°ï¼‰ ========= */
const ITEMS = [
  { name:"ç‰›ã‚³ãƒ­ã‚«ãƒ„",     emoji:"ğŸ¥©", centerClock:  60 },
  { name:"ãˆã³ãƒ•ãƒªãƒƒã‚¿ãƒ¼", emoji:"ğŸ¤", centerClock: 120 },
  { name:"ãƒ­ãƒ¼ã‚¹ãƒˆãƒãƒ¼ã‚¯", emoji:"ğŸ–", centerClock: 180 },
  { name:"ãƒ•ãƒ©ã‚¤ãƒ‰ãƒã‚­ãƒ³", emoji:"ğŸ—", centerClock: 240 },
  { name:"ãƒã‚²ãƒƒãƒˆ",       emoji:"ğŸ¥–", centerClock: 300 },
  { name:"é‡èœç››ã‚Šåˆã‚ã›", emoji:"ğŸ¥¦", centerClock:   0 },
];
const FACES = ["face.png","suprised.png","happy.png","laugh.png","funny.png"];
const FACE_MAP = {
  "ç‰›ã‚³ãƒ­ã‚«ãƒ„":"funny.png",
  "ãˆã³ãƒ•ãƒªãƒƒã‚¿ãƒ¼":"happy.png",
  "ãƒ­ãƒ¼ã‚¹ãƒˆãƒãƒ¼ã‚¯":"laugh.png",
  "ãƒ•ãƒ©ã‚¤ãƒ‰ãƒã‚­ãƒ³":"suprised.png",
  "ãƒã‚²ãƒƒãƒˆ":"face.png",
  "é‡èœç››ã‚Šåˆã‚ã›":"happy.png",
};

/* ========= çŠ¶æ…‹ã¨DOM ========= */
let spinsLeft = 0, spinning = false;
let pointerAngle = 0;  // é‡ã®æ•°å­¦è§’(rad)
let results = [];
const leftNum = document.getElementById('leftNum');
const toast = document.getElementById('toast');
const faceOverlay = document.getElementById('faceOverlay');
const faceImg = document.getElementById('faceImg');
const setLeft = n => leftNum.textContent = n;
const showToast = m => { toast.textContent=m; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1100); };

/* ========= LED ãƒªãƒ ï¼ˆå¤–å´ï¼‰ ========= */
const LED_RADIUS_PCT = 49.5;
const ledBulbs = [];
(function makeLED(){
  const ring = document.getElementById('ring');
  const bulbs = 64;
  for(let i=0;i<bulbs;i++){
    const b = document.createElement('div');
    b.className = 'bulb';
    const aMath = i/bulbs * 360;
    b.style.left = (50 + LED_RADIUS_PCT * Math.cos(deg(aMath))) + '%';
    b.style.top  = (50 + LED_RADIUS_PCT * Math.sin(deg(aMath))) + '%';
    ring.appendChild(b);
    ledBulbs.push({el:b, aMath});
  }
})();
let ledPhase = 0, ledSpeed = 0.6, ledState = 'idle';
function setLEDIdle(){ ledState='idle'; ledSpeed=0.6; highlightNone(); }
function setLEDSpin(speed){ ledState='spin'; ledSpeed = 4 * Math.min(1, speed); }
function setLEDWin(centerClock){ ledState='win'; highlightSectorClock(centerClock, 30); setTimeout(()=> setLEDIdle(), 1400); }
function highlightNone(){ ledBulbs.forEach(({el})=>{ el.style.boxShadow="0 0 8px rgba(243,200,98,.55)"; el.style.filter='brightness(.9)'; }); }
function highlightSectorClock(centerClock, half){
  const minC=(centerClock-half+360)%360, maxC=(centerClock+half+360)%360;
  ledBulbs.forEach(({el,aMath})=>{
    const aClock=(90-aMath+360)%360;
    const inArc=(minC<maxC)?(aClock>=minC&&aClock<=maxC):(aClock>=minC||aClock<=maxC);
    el.style.boxShadow = inArc ? "0 0 20px 6px rgba(255,230,160,.95), 0 0 6px rgba(255,230,160,.9)" : "0 0 6px rgba(243,200,98,.45)";
    el.style.filter = inArc ? "brightness(1.6)" : "brightness(.9)";
  });
}
function stepLED(dt){
  if(ledState==='idle' || ledState==='spin'){
    ledPhase = (ledPhase + dt*ledSpeed) % 1;
    ledBulbs.forEach(({el,aMath})=>{
      const a = aMath/360;
      const k = Math.max(0, Math.cos((a-ledPhase)*Math.PI*2*4));
      el.style.filter = `brightness(${0.6+0.4*k})`;
      el.style.boxShadow = `0 0 ${8+12*k}px rgba(243,200,98,${.35+.45*k})`;
    });
  }
}

/* ========= Three.js ========= */
const stage = document.getElementById('stage');
const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
renderer.setPixelRatio(Math.min(devicePixelRatio,2));
renderer.setSize(innerWidth, innerHeight);
stage.appendChild(renderer.domElement);
let camera;
const scene = new THREE.Scene();

/* ç›¤ */
const loader = new THREE.TextureLoader();
const tex = loader.load('roulette_ui_6_sections.png');
tex.colorSpace = THREE.SRGBColorSpace;
const wheel = new THREE.Mesh(new THREE.PlaneGeometry(1,1), new THREE.MeshBasicMaterial({ map:tex, transparent:true }));
scene.add(wheel);
// è±ªè¯ãƒªãƒ 
const rimGeo = new THREE.RingGeometry(0.49, 0.54, 96);
const rimMat = new THREE.MeshPhysicalMaterial({
  color:0xd6b253, metalness:1, roughness:.25, clearcoat:1, clearcoatRoughness:.15
});
const rimMesh = new THREE.Mesh(rimGeo, rimMat);
rimMesh.position.z = -0.001; // ç›¤ã®ã¡ã‚‡ã„ä¸‹ã«
scene.add(rimMesh);

/* â”€â”€ é‡ï¼ˆã‚ã‹ã‚Šã‚„ã™ã„ã‚¯ãƒ©ã‚·ãƒƒã‚¯çŸ¢å°verï¼‰ â”€â”€ */
// ç›¤ã®ä¸­å¿ƒ(åŸç‚¹)ã‚’å›è»¢è»¸ã«ã™ã‚‹ãŸã‚ï¼š
// pointerGroup ã¯åŸç‚¹ã«ç½®ãã€è¦‹ãŸç›®ã®é‡ã¯ã€Œã‚¢ãƒ³ã‚«ãƒ¼ã€ã‚’å°‘ã—ä¸Šã«ãšã‚‰ã—ã¦è¼‰ã›ã‚‹ã€‚
const pointerGroup = new THREE.Group();   // â† å›è»¢ç”¨ï¼ˆåŸç‚¹ï¼‰
scene.add(pointerGroup);

const pointerAnchor = new THREE.Group();  // â† è¦‹ãŸç›®ã‚’è¼‰ã›ã‚‹åœŸå°ï¼ˆä¸Šã¸ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼‰
pointerGroup.add(pointerAnchor);

function makeGlowSprite(px=320, rgba='rgba(255,90,118,1)'){
  const c=document.createElement('canvas'); c.width=c.height=px;
  const g=c.getContext('2d');
  const grd=g.createRadialGradient(px/2,px/2,0, px/2,px/2,px/2);
  grd.addColorStop(0, rgba.replace('1)', '0.55)'));
  grd.addColorStop(1, rgba.replace('1)', '0)'));
  g.fillStyle=grd; g.fillRect(0,0,px,px);
  const t=new THREE.CanvasTexture(c); t.colorSpace=THREE.SRGBColorSpace;
  return new THREE.Sprite(new THREE.SpriteMaterial({map:t,transparent:true,blending:THREE.AdditiveBlending,depthWrite:false}));
}

// ã“ã“ã‹ã‚‰ buildPointer ã‚’ä¸¸ã”ã¨ç½®æ›
function buildPointer(){
  const g = new THREE.Group();

  // å°åº§ï¼ˆåšã‚ãƒ»é‡‘å±æ„ŸUPï¼‰
  const base = new THREE.Mesh(
    new THREE.CylinderGeometry(0.22,0.26,0.08,64),
    new THREE.MeshPhysicalMaterial({
      color:0x9c7b2f, metalness:1, roughness:.22, clearcoat:1, clearcoatRoughness:.15
    })
  );
  base.position.set(0,-0.04,0);
  g.add(base);

  // ã‚·ãƒ£ãƒ•ãƒˆï¼ˆç™½ç£ã£ã½ã„è³ªæ„Ÿï¼‰
  const shaft = new THREE.Mesh(
    new THREE.CapsuleGeometry(0.055,0.28, 1, 24),
    new THREE.MeshPhysicalMaterial({
      color:0xf7f7fb, metalness:.15, roughness:.2, transmission:.0, clearcoat:1
    })
  );
  shaft.position.y = 0.12;
  g.add(shaft);

  // é‡‘ãƒªãƒ³ã‚°ï¼ˆã‚·ãƒ£ãƒ•ãƒˆã¨çŸ¢ã˜ã‚Šã®å¢ƒç›®ï¼‰
  const collar = new THREE.Mesh(
    new THREE.TorusGeometry(0.09, 0.018, 24, 64),
    new THREE.MeshPhysicalMaterial({ color:0xd8b04f, metalness:1, roughness:.2, clearcoat:1 })
  );
  collar.rotation.x = Math.PI/2;
  collar.position.y = 0.26;
  g.add(collar);

  // çŸ¢ã˜ã‚Šï¼ˆç™½ã‚³ãƒ¼ãƒ³ï¼‹èµ¤ã‚¨ãƒŸãƒƒã‚·ãƒ–ã®å…ˆç«¯ã‚«ãƒãƒ¼ã§â€œçŸ¢å°æ„Ÿâ€ï¼‰
  const headBody = new THREE.Mesh(
    new THREE.ConeGeometry(0.16,0.26, 48),
    new THREE.MeshPhysicalMaterial({ color:0xffffff, metalness:.2, roughness:.3, clearcoat:1 })
  );
  headBody.rotation.z = Math.PI;         // å…ˆç«¯ã‚’ä¸Šå‘ã
  headBody.position.y = 0.26 + 0.13;
  g.add(headBody);

  // å…ˆç«¯ã‚­ãƒ£ãƒƒãƒ—ï¼ˆèµ¤ãå…‰ã‚‹ï¼‰
  const tipCap = new THREE.Mesh(
    new THREE.ConeGeometry(0.125,0.1, 40),
    new THREE.MeshPhysicalMaterial({
      color:0xff3b3b, emissive:0x991122, emissiveIntensity:0.9,
      metalness:.2, roughness:.25, clearcoat:1
    })
  );
  tipCap.rotation.z = Math.PI;
  tipCap.position.y = headBody.position.y + 0.13;
  g.add(tipCap);

  // ãƒ€ã‚¤ãƒ¤é¢¨ã®å…ˆç 
  const tip = new THREE.Mesh(
    new THREE.OctahedronGeometry(0.045, 1),
    new THREE.MeshStandardMaterial({ color:0xfff3c0, emissive:0xffe39a, emissiveIntensity:1.3, metalness:.3, roughness:.2 })
  );
  tip.position.y = tipCap.position.y + 0.08;
  g.add(tip);

  // ã‚°ãƒ­ãƒ¼ï¼ˆç™½Ã—é‡‘ã®2å±¤ï¼‰
  const glowWhite = makeGlowSprite(520, 'rgba(255,255,255,1)');
  glowWhite.position.set(0, tip.position.y, 0.02);
  glowWhite.scale.set(0.50,0.50,1);

  const glowGold = makeGlowSprite(560, 'rgba(255,210,120,1)');
  glowGold.position.set(0, tip.position.y - 0.02, 0.01);
  glowGold.scale.set(0.58,0.58,1);

  g.add(glowWhite, glowGold);
  return g;
}
// ã“ã“ã¾ã§ç½®æ›
const pointerVisual = buildPointer();
pointerAnchor.add(pointerVisual);
/* ãƒªã‚µã‚¤ã‚ºï¼†é…ç½®ï¼ˆã‚µã‚¤ã‚ºä¾å­˜ã¯ã“ã“ã§ã ã‘å‡¦ç†ï¼‰ */
function fit(){
  const w = innerWidth, h = innerHeight;
  renderer.setSize(w,h);
  camera = new THREE.OrthographicCamera(-w/2, w/2, h/2, -h/2, -10, 10);
  camera.position.set(0,0,5); camera.lookAt(0,0,0);

  const size = Math.min(w,h) * 0.86;   // ç›¤ã‚µã‚¤ã‚º
  wheel.scale.set(size, size, 1);
  // fit() å†…ã® wheel.scale.set(size, size, 1); ã®ç›´å¾Œã«è¿½è¨˜
rimMesh.scale.set(size, size, 1);

  // é‡ã®ã‚¹ã‚±ãƒ¼ãƒ«ã¨è¦‹ãŸç›®ã®ã‚ªãƒ•ã‚»ãƒƒãƒˆ
  const pointerScale = size * 0.22;
  pointerGroup.scale.set(pointerScale, pointerScale, pointerScale);
  pointerGroup.position.set(0,0,0);         // å›è»¢ä¸­å¿ƒã¯åŸç‚¹
  const offset = size * 0.40 / pointerScale; // è¦‹ãŸç›®ã ã‘ä¸Šã¸
  pointerAnchor.position.set(0, offset, 0);

  // åˆæœŸè§’
  pointerGroup.rotation.z = pointerAngle = 0;
}
addEventListener('resize', fit); fit();

// ç€åœ°å¾Œã®å°ãƒã‚¦ãƒ³ã‚¹ï¼ˆè¦–è¦šã®ã¿ï¼šæœ€çµ‚å½“ãŸã‚Šã¯å¤‰ãˆãªã„ï¼‰
(function settleBounce(){
  const base = pointerGroup.rotation.z;     // ç€åœ°è§’
  const start = performance.now();
  const D = 380;                             // å…¨ä½“ã®é•·ã•(ms)
  function easeOutExpo(t){ return 1 - Math.pow(2, -10*t); }
  function frame(now){
    const t = Math.min(1, (now - start)/D);
    const amp = deg(1.1) * (1 - t);         // æŒ¯å¹…ã¯å¾ã€…ã«æ¸›è¡°ï¼ˆæœ€å¤§ç´„1.1Â°ï¼‰
    pointerGroup.rotation.z = base + Math.sin(t * Math.PI * 2) * amp * easeOutExpo(t);
    if (t < 1) requestAnimationFrame(frame);
    else pointerGroup.rotation.z = base;     // æœ€çµ‚çš„ã«ã´ã£ãŸã‚Šæˆ»ã™
  }
  requestAnimationFrame(frame);
})();

/* ========= ã‚ªãƒ¼ãƒ‡ã‚£ã‚ª ========= */
let audioCtx, master, loopTimer, muted=false, bgmNode;
function ensureAudio(){
  if(audioCtx) return;
  audioCtx=new (window.AudioContext||window.webkitAudioContext)();
  master=audioCtx.createGain(); master.gain.value=.45; master.connect(audioCtx.destination);
  const bpm=112, beat=60/bpm;
  function startBGM(){
    if(muted) return; stopBGM();
    bgmNode=setInterval(()=>{
      const t0=audioCtx.currentTime;
      for(let step=0; step<8; step++){
        const t=t0+step*beat/2;
        const f=[392,494,587,659][step%4];
        const o=audioCtx.createOscillator(); o.type='sine'; o.frequency.value=f;
        const g=audioCtx.createGain(); g.gain.value=0.0001; o.connect(g).connect(master);
        o.start(t); g.gain.setValueAtTime(0.0001,t);
        g.gain.exponentialRampToValueAtTime(0.10,t+0.02);
        g.gain.exponentialRampToValueAtTime(0.0001,t+beat/2-0.02);
        o.stop(t+beat/2);
      }}
    , beat*1000*4);
  }
  function stopBGM(){ if(bgmNode){ clearInterval(bgmNode); bgmNode=null; } }
  ensureAudio.startBGM=startBGM; ensureAudio.stopBGM=stopBGM;
}
function startSpinLoop(){
  if(muted) return; ensureAudio(); stopSpinLoop();
  loopTimer=setInterval(()=>{
    const freqs=[523.25,659.25,783.99];
    freqs.forEach((f,i)=>{
      const t=audioCtx.currentTime+i*0.08;
      const o=audioCtx.createOscillator(); o.type='triangle'; o.frequency.value=f;
      const g=audioCtx.createGain(); g.gain.value=0.0001; o.connect(g).connect(master);
      o.start(t); g.gain.setValueAtTime(0.0001,t);
      g.gain.exponentialRampToValueAtTime(0.22,t+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001,t+0.15);
      o.stop(t+0.16);
    });
  },260);
}
function stopSpinLoop(){ if(loopTimer){ clearInterval(loopTimer); loopTimer=null; } }
function playHitSFX(){
  if(muted) return; ensureAudio();
  const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
  o.type='square'; o.frequency.setValueAtTime(880, audioCtx.currentTime);
  g.gain.value=0.0001; o.connect(g).connect(master); o.start();
  const t=audioCtx.currentTime;
  g.gain.exponentialRampToValueAtTime(0.35,t+0.01);
  o.frequency.exponentialRampToValueAtTime(1760,t+0.12);
  g.gain.exponentialRampToValueAtTime(0.0001,t+0.28);
  o.stop(t+0.30);
}

/* ========= åˆ¤å®šï¼ˆè§’åº¦â†’ã‚¢ã‚¤ãƒ†ãƒ ï¼‰ ========= */
// é‡â†’æ™‚è¨ˆè§’ã®è£œæ­£ï¼ˆ+ãªã‚‰æ™‚è¨ˆå›ã‚Šã€âˆ’ãªã‚‰åæ™‚è¨ˆå›ã‚Šï¼‰
const JUDGE_OFFSET_CLOCK = -90; // â† ãšã‚ŒãŒé€†ãªã‚‰ -90 ã«

function clockDegFromRad(rad){
  const mathDeg = (radToDeg(rad) % 360 + 360) % 360;
  // 0=12æ™‚ã®æ™‚è¨ˆè§’ã«å¤‰æ›ã—ã¦ã‹ã‚‰è£œæ­£ã‚’åŠ ãˆã‚‹
  return ((90 - mathDeg + 360) % 360 + JUDGE_OFFSET_CLOCK) % 360;
}
function itemIdxByClockDeg(a){
  const d=((a%360)+360)%360;
  if(d>=30 && d<90)   return 0; // ç‰›
  if(d>=90 && d<150)  return 1; // ãˆã³
  if(d>=150 && d<210) return 2; // ãƒ­ãƒ¼ã‚¹ãƒˆ
  if(d>=210 && d<270) return 3; // ãƒ•ãƒ©ã‚¤ãƒ‰
  if(d>=270 && d<330) return 4; // ãƒã‚²ãƒƒãƒˆ
  return 5;                      // é‡èœ
}
function idxByAngleRad(rad){ return itemIdxByClockDeg(clockDegFromRad(rad)); }
function targetAngleForIdx(idx){ return deg(toMathDeg(ITEMS[idx].centerClock)); }
function faceFor(name){ return FACE_MAP[name] || "face.png"; }

/* ========= ã‚¹ãƒ”ãƒ³ï¼ˆã‚†ã£ãã‚Šæ­¢ã¾ã‚‹ï¼‰ ========= */
let omega=0, spinMode='idle';
const OMEGA_MAX=10, ACCEL=16;
let stopStartAngle=0, stopTargetAngle=0, stopElapsed=0, stopDuration=3.0;
const shortestDelta=(from,to)=>{ let d=norm(to)-norm(from); if(d>Math.PI) d-=TAU; if(d<-Math.PI) d+=TAU; return d; };

function startSpin(){
  if(spinning || spinsLeft<=0) return;
  spinning=true;
  document.getElementById('spin').disabled=true;
  document.getElementById('stop').disabled=false;

  ensureAudio(); ensureAudio.startBGM?.();
  startSpinLoop();

  spinMode='spin'; omega=0.0001; setLEDSpin(0.2);
}
function pressStop(){
  if (spinMode !== 'spin') return;
  spinMode = 'stoppingTween';
  stopSpinLoop();

  // ç¾åœ¨è§’åº¦ï¼ˆæ•°å­¦è§’, radï¼‰ã¨ã€Œä»ŠæŒ‡ã—ã¦ã„ã‚‹åŒºç”»ã€
  const nowA = norm(pointerGroup.rotation.z);
  const idx  = idxByAngleRad(nowA);

  // ãã®åŒºç”»ã®ä¸­å¿ƒè§’ï¼ˆæ•°å­¦è§’, radï¼‰
  const centerTgt = targetAngleForIdx(idx);

  // â”€â”€ ãƒ©ãƒ³ãƒ€ãƒ ã«ãšã‚‰ã—ã¦ã€ŒåŒºç”»ã®ä¸­ã®ã©ã“ã‹ã€ã§æ­¢ã‚ã‚‹ â”€â”€
  // åŒºç”»å¹…ã¯60Â°ãªã®ã§ã€Â±30Â°ã®ç¯„å›²ã§ã‚¸ãƒƒã‚¿ãƒ¼ã‚’ä¸ãˆã‚‹
  const maxOffset = THREE.MathUtils.degToRad(30);
  const jitter    = (Math.random() * 2 - 1) * maxOffset; // -30Â°ã€œ+30Â°
  const tgt       = centerTgt + jitter;

  // 4ã€œ6å‘¨ã—ãªãŒã‚‰ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¸ï¼ˆè‡ªç„¶ã«è¦‹ãˆã‚‹å‘¨å›æ•°ï¼‰
  const laps = 4 + Math.floor(Math.random() * 3);

  stopStartAngle  = nowA;
  stopTargetAngle = nowA + laps * TAU + shortestDelta(nowA, tgt);
  stopElapsed     = 0;

  // åœæ­¢ã®é•·ã•ã‚‚å°‘ã—ãƒ©ãƒ³ãƒ€ãƒ ã«ï¼ˆ2.7ã€œ3.3ç§’ï¼‰
  stopDuration = 2.7 + Math.random() * 0.6;
}
function finishStop(){
  pointerGroup.rotation.z = norm(stopTargetAngle);
  pointerAngle = pointerGroup.rotation.z;
  spinMode='idle'; omega=0; setLEDIdle();

  const idx = idxByAngleRad(pointerAngle);
  const it  = ITEMS[idx];
  results.push({ idx, name: it.name, emoji: it.emoji });

  faceImg.src = faceFor(it.name);
  faceOverlay.style.display='grid';
  playHitSFX(); showToast(`${it.emoji} ${it.name}ï¼`);
  setLEDWin(ITEMS[idx].centerClock);
  setTimeout(()=>{ faceOverlay.style.display='none'; }, 1700);

  spinsLeft -= 1; setLeft(spinsLeft);
  spinning=false;
  document.getElementById('spin').disabled=(spinsLeft<=0);
  document.getElementById('stop').disabled=true;
  if(spinsLeft<=0) showSummary();
}
function stepSpin(dt){
  if(spinMode==='idle') return;

  if(spinMode==='spin'){
    omega=Math.min(OMEGA_MAX, omega + ACCEL*dt);
    pointerGroup.rotation.z = norm(pointerGroup.rotation.z + omega*dt);
    setLEDSpin(omega/OMEGA_MAX);
    return;
  }
  if(spinMode==='stoppingTween'){
    stopElapsed += dt;
    const t=Math.min(1, stopElapsed/stopDuration);
    const ease=1 - Math.pow(1-t, 3); // easeOutCubic
    const total=stopTargetAngle - stopStartAngle;
    pointerGroup.rotation.z = norm(stopStartAngle + total*ease);
    setLEDSpin(1 - t*0.95);
    if(t>=1) finishStop();
  }
}

/* ========= ã‚µãƒãƒªãƒ¼ ========= */
function showSummary(){
  const map=new Map();
  results.forEach(r=> map.set(r.name,(map.get(r.name)||0)+1));
  const rows=[...map.entries()].map(([n,c])=>`<tr><td>${n}</td><td style="text-align:right">${c}</td></tr>`).join('');
  document.getElementById('list').innerHTML =
    `<table><thead><tr><th>ãƒ¡ãƒ‹ãƒ¥ãƒ¼</th><th style="text-align:right">æ•°é‡</th></tr></thead><tbody>${rows||'<tr><td colspan="2">ãªã—</td></tr>'}</tbody></table>`;
  document.getElementById('summary').style.display='block';
}

/* ========= ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ========= */
let last=performance.now();
function render(){
  const now=performance.now();
  const dt=Math.min(0.05,(now-last)/1000);
  last=now;

  stepSpin(dt);
  stepLED(dt);

  wheel.rotation.z=0; // ç›¤ã¯å›ºå®š
  renderer.render(scene,camera);
  requestAnimationFrame(render);
}
render();

/* ========= UI ========= */
document.getElementById('spin').addEventListener('click', startSpin);
document.getElementById('stop').addEventListener('click', pressStop);
document.getElementById('reset').addEventListener('click', ()=>{
  stopSpinLoop(); ensureAudio?.stopBGM?.();
  results=[]; spinsLeft=0; setLeft('--');
  document.getElementById('summary').style.display='none';
  document.getElementById('spin').disabled=false;
  document.getElementById('stop').disabled=true;
  pointerGroup.rotation.z = pointerAngle = 0;
  spinMode='idle'; setLEDIdle();
  document.getElementById('start').style.display='grid';
});
document.getElementById('mute').addEventListener('click', ()=>{
  muted=!muted; showToast(muted?'ãƒŸãƒ¥ãƒ¼ãƒˆ':'ã‚µã‚¦ãƒ³ãƒ‰ON');
});



/* ã‚µãƒãƒªãƒ¼å¾Œã®æ“ä½œ */
document.getElementById('again').addEventListener('click', ()=>{
  document.getElementById('summary').style.display='none';
  document.getElementById('start').style.display='grid';
});
document.getElementById('closeSummary').addEventListener('click', ()=>{
  document.getElementById('summary').style.display='none';
});
// äººæ•°ãƒœã‚¿ãƒ³ã§ã‚¹ã‚¿ãƒ¼ãƒˆ
document.querySelectorAll('.numBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const p = Number(btn.dataset.p);
    spinsLeft = p * 2;
    setLeft(spinsLeft);
    results = [];
    document.getElementById('start').style.display='none';
    ensureAudio(); ensureAudio.startBGM?.();
    showToast(`äººæ•° ${p}äºº / åˆè¨ˆ ${spinsLeft}å›`);
  });
});
</script>
</body>
</html>
