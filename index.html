<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Wonder Roulette PRO — Video Edition</title>
<style>
  :root{
    --bg:#0b0d19; --panel:#151a33; --ink:#f5f7ff; --muted:#a8b1d9;
    --gold1:#ffe08a; --gold2:#f7b733; --gold3:#cc8a00; --accent:#ff6d6d;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:radial-gradient(1200px 700px at 75% -10%, rgba(255,255,255,.06), transparent 60%), var(--bg); color:var(--ink); font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,"Noto Sans JP",Arial}
  header{position:sticky;top:0;z-index:40;display:flex;gap:12px;align-items:center;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg,rgba(255,255,255,.04),transparent)}
  .tag{background:var(--gold1);color:#111;padding:4px 8px;border-radius:999px;font-weight:900;font-size:12px}
  h1{margin:0;font-size:clamp(18px,3.2vw,28px)}
  main{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;padding:16px}
  @media (max-width:980px){main{grid-template-columns:1fr}}
  .panel{background:radial-gradient(700px 300px at 100% 0, rgba(255,255,255,.05), transparent 40%), var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px;position:relative;overflow:hidden}
  .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:8px 0 12px}
  .group{display:flex;gap:8px;align-items:center;background:#0c1030;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:8px 10px}
  label{font-size:12px;color:var(--muted)}
  input[type="number"],input[type="text"]{background:#0a0e24;color:var(--ink);border:1px solid rgba(255,255,255,.14);border-radius:10px;padding:8px 10px;font-size:14px}
  input[type="file"]{color:var(--muted);font-size:12px}
  button{appearance:none;border:none;border-radius:12px;background:linear-gradient(180deg,var(--gold1),var(--gold2));color:#151515;font-weight:900;letter-spacing:.02em;padding:10px 14px;cursor:pointer;box-shadow:0 8px 24px rgba(255,208,90,.25), inset 0 1px 0 rgba(255,255,255,.5)}
  button.ghost{background:#222848;color:var(--ink);border:1px solid rgba(255,255,255,.12);box-shadow:none}
  .mini{font-size:12px;color:var(--muted)}
  .stage{display:grid;grid-template-columns:minmax(280px,640px) 1fr;gap:18px;align-items:center}
  @media (max-width:980px){.stage{grid-template-columns:1fr}}
  /* wheel */
  .wheel-wrap{position:relative;aspect-ratio:1/1;width:100%;display:grid;place-items:center;isolation:isolate}
  .pointer{position:absolute;top:-4px;left:50%;transform:translateX(-50%);width:0;height:0;border-left:18px solid transparent;border-right:18px solid transparent;border-bottom:28px solid var(--accent);filter:drop-shadow(0 6px 12px rgba(255,109,109,.55));z-index:5}
  .wheel{position:relative;width:92%;aspect-ratio:1/1;border-radius:50%;transition:transform 5.2s cubic-bezier(.15,.9,.05,1);transform:rotate(0deg);}
  .rim{position:absolute;inset:-10px;border-radius:50%;background:conic-gradient(from 0deg, rgba(255,220,120,.3), rgba(255,220,120,0) 12%, rgba(255,220,120,.3) 24%, rgba(255,220,120,0) 36%, rgba(255,220,120,.3) 48%, rgba(255,220,120,0) 60%, rgba(255,220,120,.3) 72%, rgba(255,220,120,0) 84%, rgba(255,220,120,.3)), radial-gradient(60% 60% at 50% 50%, rgba(0,0,0,.25), transparent 70%);
    animation: chase 3s linear infinite; pointer-events:none}
  @keyframes chase{to{transform:rotate(360deg)}}
  .slice{position:absolute;inset:0;display:grid;place-items:center;clip-path:polygon(50% 50%, 100% 0%, 100% 100%);}
  .slice .media{position:absolute;inset:0;display:grid;place-items:center;transform:rotate(0deg);}
  .slice .bubble{display:grid;place-items:center;background:rgba(255,255,255,.95);border-radius:50%;box-shadow:0 8px 16px rgba(0,0,0,.2);width:52%;aspect-ratio:1/1;overflow:hidden}
  .slice video,.slice img{width:100%;height:100%;object-fit:cover;display:block}
  .center{position:absolute;inset:50% auto auto 50%;transform:translate(-50%,-50%);width:33%;aspect-ratio:1/1;border-radius:50%;display:grid;place-items:center;background:radial-gradient(circle at 40% 35%, #ffd86a, #ffb300 65%, #d88900 66%, #d88900 80%, #8a5400);box-shadow:0 12px 40px rgba(0,0,0,.45), inset 0 2px 3px rgba(255,255,255,.45)}
  .center::after{content:"🫕";font-size:clamp(28px,6vw,44px)}
  .spot{position:absolute;inset:0;background:radial-gradient(180px 140px at 50% 6%, rgba(255,255,255,.18), rgba(255,255,255,0) 60%);mix-blend-mode:screen;pointer-events:none;z-index:3}
  .rare-halo{position:absolute;inset:-4px;border-radius:50%;box-shadow:0 0 0 10px rgba(255,208,80,.0), 0 0 60px rgba(255,208,80,.0);pointer-events:none;transition:.4s}
  .rare .rare-halo{box-shadow:0 0 0 10px rgba(255,208,80,.22), 0 0 60px rgba(255,208,80,.35)}
  .banner{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);padding:8px 12px;border-radius:999px;background:linear-gradient(180deg,var(--gold1),var(--gold2));color:#111;font-weight:900;letter-spacing:.02em;box-shadow:0 6px 18px rgba(255,206,90,.3);display:none;z-index:6}
  .banner.show{display:inline-block}
  .weights{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  @media (max-width:720px){.weights{grid-template-columns:1fr}}
  .row{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;padding:8px;background:#0b1030;border:1px solid rgba(255,255,255,.08);border-radius:12px}
  .row input[type="range"]{width:160px}
  .badge{font-size:11px;color:#111;background:var(--gold1);padding:2px 6px;border-radius:999px;font-weight:800}
  .orders table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,.08);font-size:14px}
  .toast{position:fixed;left:50%;top:14px;transform:translateX(-50%) translateY(-16px);background:#111533;color:var(--ink);border:1px solid rgba(255,255,255,.14);padding:10px 14px;border-radius:14px;font-weight:800;opacity:0;transition:.25s;z-index:100}
  .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
</style>
</head>
<body>
<header>
  <span class="tag">Cheese Wonderland</span>
  <h1>Wonder Roulette PRO — Video Edition</h1>
</header>

<main>
  <section class="panel">
    <div class="controls">
      <div class="group">
        <label>人数</label>
        <input type="number" id="people" min="1" step="1" value="2">
        <button id="apply">設定</button>
        <span class="mini">残り <b id="spinsLeft">--</b> 回</span>
      </div>
      <div class="group">
        <button id="spin">回す</button>
        <button id="undo" class="ghost">一手戻す</button>
        <button id="reset" class="ghost">リセット</button>
        <span class="mini">Fで全画面</span>
      </div>
      <div class="group">
        <button id="loadPlaceholders" class="ghost">簡易プレースホルダ</button>
        <button id="clearMedia" class="ghost">媒体クリア</button>
        <button id="exportCSV">CSV書き出し</button>
      </div>
    </div>

    <div class="stage">
      <div class="wheel-wrap">
        <div class="pointer"></div>
        <div class="wheel" id="wheel">
          <div class="rim"></div>
          <!-- slices injected by JS -->
          <div class="center"></div>
          <div class="rare-halo" id="rareHalo"></div>
        </div>
        <div class="spot"></div>
        <div class="banner" id="rareBanner">🎂 激レア：バスクチーズケーキ！</div>
      </div>

      <div>
        <div id="weights" class="weights"></div>
      </div>
    </div>
  </section>

  <section class="panel orders">
    <h3>注文リスト</h3>
    <table>
      <thead><tr><th style="text-align:left;">メニュー</th><th>確率</th><th style="text-align:right;">数量</th></tr></thead>
      <tbody id="orderBody"></tbody>
    </table>
  </section>
</main>

<div class="toast" id="toast">設定しました</div>

<script>
<script>
const DEFAULT_SLICES = [
  { key:"baguette", label:"バゲット", rare:false, weight:15 },
  { key:"veggies", label:"野菜盛り", rare:false, weight:13 },
  { key:"korokatsu", label:"牛コロカツ", rare:false, weight:13 },
  { key:"chicken", label:"フライドチキン", rare:false, weight:13 },
  { key:"pork", label:"ローストポーク", rare:false, weight:12 },
  { key:"shrimp", label:"えびフリッター", rare:false, weight:12 },
  { key:"basque", label:"バスクチーズケーキ", rare:true, weight:2 }
];
let slices = JSON.parse(localStorage.getItem("wr_video_slices")||"null") || DEFAULT_SLICES.map(s=>({...s}));
// mediaMap: { key: {type:"video"|"image", src:string(URL or data)} }
let mediaMap = JSON.parse(localStorage.getItem("wr_video_media")||"null") || {};
let spinsLeft=0, spinning=false, history=[], rotation=0;

const wheelEl = document.getElementById("wheel");
const banner = document.getElementById("rareBanner");
const weightsEl = document.getElementById("weights");
const toast = document.getElementById("toast");

function showToast(msg){ toast.textContent = msg; toast.classList.add("show"); setTimeout(()=>toast.classList.remove("show"), 1400); }
function totalWeight(){ return slices.reduce((a,b)=> a + Number(b.weight||0), 0); }
function pct(w){ const t=totalWeight(); return t? (w/t*100) : 0; }

function save(){ localStorage.setItem("wr_video_slices", JSON.stringify(slices)); localStorage.setItem("wr_video_media", JSON.stringify(mediaMap)); }

function buildSlices(){
  wheelEl.querySelectorAll(".slice").forEach(n=>n.remove());
  const n = slices.length;
  const arc = 360/n;
  for(let i=0; i<n; i++){
    const s = slices[i];
    const slice = document.createElement("div");
    slice.className = "slice" + (s.rare ? " rare" : "");
    slice.style.transform = `rotate(${i*arc}deg)`;

    const media = document.createElement("div");
    media.className = "media";
    media.style.transform = `rotate(${-i*arc}deg)`;

    const bubble = document.createElement("div");
    bubble.className = "bubble";

    const m = mediaMap[s.key];
    if(m){
      if(m.type === "video"){
        const v = document.createElement("video");
        v.src = m.src; v.loop = true; v.muted = true; v.autoplay = true; v.playsInline = true;
        v.oncanplay = ()=> v.play().catch(()=>{});
        bubble.appendChild(v);
      }else{
        const img = document.createElement("img");
        img.src = m.src; bubble.appendChild(img);
      }
    }else{
      // プレースホルダ
      const ph = document.createElement("div");
      ph.style.display="grid"; ph.style.placeItems="center"; ph.style.width="100%"; ph.style.height="100%"; ph.style.background="#fff";
      ph.innerHTML = `<div style="font-size:42px">${placeholderEmoji(s.key)}</div>`;
      bubble.appendChild(ph);
    }

    media.appendChild(bubble);
    slice.appendChild(media);
    wheelEl.appendChild(slice);
  }
  applyClipPaths();
}

function applyClipPaths(){
  const n = slices.length;
  const step = 360/n;
  const slicesEls = wheelEl.querySelectorAll(".slice");
  slicesEls.forEach((el, i)=>{
    const pts = polyWedge(i*step, (i+1)*step);
    el.style.clipPath = `polygon(${pts})`;
  });
  function polyWedge(a0, a1){
    const steps = 6;
    const pts = ["50% 50%"];
    for(let k=0;k<=steps;k++){
      const a = (a0 + (a1-a0)*(k/steps)) * Math.PI/180;
      const x = 50 + Math.cos(a)*50;
      const y = 50 + Math.sin(a)*50;
      pts.push(`${x}% ${y}%`);
    }
    return pts.join(", ");
  }
}

function placeholderEmoji(key){
  switch(key){
    case "baguette": return "🥖";
    case "veggies": return "🥦";
    case "korokatsu": return "🥩";
    case "chicken": return "🍗";
    case "pork": return "🍖";
    case "shrimp": return "🍤";
    case "basque": return "🍰";
  }
  return "🍽️";
}

function buildWeightsUI(){
  weightsEl.innerHTML = "";
  slices.forEach((s, idx)=>{
    const row = document.createElement("div"); row.className="row";
    const left = document.createElement("div");
    const title = document.createElement("div"); 
    title.innerHTML = `<span class="badge">${s.rare?"激レア":"枠"}</span> ${s.label}（≈ ${(pct(s.weight)).toFixed(1)}%）`;
    const up = document.createElement("input"); up.type="file"; up.accept="video/*,image/*";
    up.addEventListener("change", e=>{
      const f = e.target.files[0]; if(!f) return;
      const url = URL.createObjectURL(f);
      mediaMap[s.key] = { type: f.type.startsWith("video") ? "video" : "image", src: url };
      save(); buildSlices();
    });
    const urlIn = document.createElement("input"); urlIn.type="text"; urlIn.placeholder="動画/画像のURL"; 
    urlIn.value = mediaMap[s.key] && !mediaMap[s.key].src.startsWith("blob:") ? mediaMap[s.key].src : "";
    urlIn.addEventListener("change", ()=>{
      const v = urlIn.value.trim(); if(!v) return;
      const type = v.match(/\.(mp4|webm|mov)(\?|$)/i) ? "video" : "image";
      mediaMap[s.key] = { type, src: v };
      save(); buildSlices();
    });

    left.appendChild(title);
    left.appendChild(up);
    left.appendChild(urlIn);

    const right = document.createElement("div"); 
    right.style.display="flex"; right.style.alignItems="center"; right.style.gap="8px";
    const rng = document.createElement("input"); rng.type="range"; rng.min=0; rng.max=40; rng.value = s.weight;
    const num = document.createElement("input"); num.type="number"; num.min=0; num.max=200; num.value = s.weight; num.style.width="70px";
    const sync = ()=>{ s.weight = Number(num.value||0); rng.value = String(s.weight); save(); refreshOrders(); };
    rng.addEventListener("input", ()=>{ num.value = rng.value; sync(); });
    num.addEventListener("input", sync);

    right.appendChild(rng); right.appendChild(num);
    row.appendChild(left); row.appendChild(right);
    weightsEl.appendChild(row);
  });
}

function weightedPick(){
  const tot = totalWeight() || 1;
  let r = Math.random()*tot;
  for(let i=0;i<slices.length;i++){
    r -= Number(slices[i].weight||0);
    if(r <= 0) return i;
  }
  return slices.length-1;
}

function spin(){
  if(spinning || spinsLeft<=0) return;
  spinning = true; document.getElementById("spin").disabled = true;
  const n = slices.length; const arc = 360/n;
  const idx = weightedPick();
  const center = idx*arc + arc/2;
  const turns = 6 + Math.floor(Math.random()*2);
  const jitter = (Math.random()*arc*0.2) - (arc*0.1);
  const dest = -(turns*360 + center + jitter);
  wheelEl.style.transition = "transform 5.2s cubic-bezier(.15,.9,.05,1)";
  wheelEl.style.transform = `rotate(${dest}deg)`;
  const onEnd = ()=>{
    wheelEl.removeEventListener("transitionend", onEnd);
    rotation = dest;
    history.push(idx); spinsLeft -= 1; refreshOrders();
    if(slices[idx].rare){
      banner.classList.add("show"); setTimeout(()=>banner.classList.remove("show"), 2000);
      confetti();
    }
    spinning = false; document.getElementById("spin").disabled = spinsLeft<=0;
  };
  wheelEl.addEventListener("transitionend", onEnd);
}

function confetti(){
  const colors = ["#ff4757","#ffd166","#06d6a0","#4cc9f0","#f72585","#b5179e","#ff9f1a","#f8f32b"];
  for(let i=0;i<160;i++){
    const d = document.createElement("div");
    d.style.position="fixed"; d.style.top="-10px"; d.style.left=(Math.random()*100)+"vw";
    d.style.width="10px"; d.style.height="14px"; d.style.background=colors[i%colors.length];
    d.style.transform="translateY(0) rotate(0deg)"; d.style.opacity=.95; d.style.zIndex=400; d.style.pointerEvents="none";
    d.style.transition="transform 7s linear, opacity 7s linear";
    document.body.appendChild(d);
    requestAnimationFrame(()=>{ const rot=720+Math.random()*1440; d.style.transform=`translateY(110vh) rotate(${rot}deg)`; d.style.opacity=.0; });
    setTimeout(()=>d.remove(), 7200);
  }
}

function refreshOrders(){
  const body = document.getElementById("orderBody"); body.innerHTML="";
  const counts = new Map(); history.forEach(i=>counts.set(i,(counts.get(i)||0)+1));
  const t = totalWeight();
  slices.forEach((s,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${s.label}${s.rare?' <span class="badge">激レア</span>':''}</td><td>≈ ${(t?(s.weight/t*100):0).toFixed(1)}%</td><td style="text-align:right;">${counts.get(i)||0}</td>`;
    body.appendChild(tr);
  });
  document.getElementById("spinsLeft").textContent = spinsLeft;
}

document.getElementById("loadPlaceholders").addEventListener("click", ()=>{
  const svg = emoj => "data:image/svg+xml;charset=utf-8,"+encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='300' height='300'><rect width='100%' height='100%' fill='white'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='64'>${emoj}</text></svg>`);
  mediaMap = {
    baguette:{type:"image",src:svg("🥖")},
    veggies:{type:"image",src:svg("🥦")},
    korokatsu:{type:"image",src:svg("🥩")},
    chicken:{type:"image",src:svg("🍗")},
    pork:{type:"image",src:svg("🍖")},
    shrimp:{type:"image",src:svg("🍤")},
    basque:{type:"image",src:svg("🍰")},
  };
  save(); buildSlices(); showToast("プレースホルダを設定しました（動画/画像を行ごとに差し替え可）");
});
document.getElementById("clearMedia").addEventListener("click", ()=>{ mediaMap={}; save(); buildSlices(); showToast("媒体設定をクリアしました"); });
document.getElementById("exportCSV").addEventListener("click", ()=>{
  const counts = new Map(); history.forEach(i=>counts.set(i,(counts.get(i)||0)+1));
  let csv = "メニュー,数量\n"; slices.forEach((s,i)=>{ const q = counts.get(i)||0; if(q>0) csv += `${s.label},${q}\n`; });
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"}); const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href=url; a.download="orders_video_roulette.csv"; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url), 500);
});

document.getElementById("apply").addEventListener("click", ()=>{
  const p = Math.max(1, Math.floor(Number(document.getElementById("people").value)||0));
  spinsLeft = p*2; refreshOrders(); showToast(`人数 ${p}人 / 合計 ${spinsLeft}回`);
});
document.getElementById("spin").addEventListener("click", spin);
document.getElementById("undo").addEventListener("click", ()=>{ if(spinning||history.length===0) return; history.pop(); spinsLeft += 1; refreshOrders(); });
document.getElementById("reset").addEventListener("click", ()=>{ if(spinning) return; history=[]; spinsLeft=0; refreshOrders(); });

document.addEventListener("keydown", e=>{
  if(e.key.toLowerCase()==="f"){
    const de = document.documentElement;
    if(!document.fullscreenElement){ de.requestFullscreen?.(); } else { document.exitFullscreen?.(); }
  }
});

function init(){
  buildSlices();
  buildWeightsUI();
  refreshOrders();
}
init();
</script>
</script>
</body>
</html>
